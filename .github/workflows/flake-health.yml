name: Flake Health

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

concurrency:
  group: flake-health
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  health:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Set up Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Run flake freshness policy
        uses: DeterminateSystems/flake-checker-action@main
        with:
          nixpkgs-keys: nixpkgs,nixpkgs-unstable

      - name: Build forge closure
        run: |
          nix build .#ciSystems.forge \
            --profile ./profile \
            --fallback \
            -v \
            --log-format raw

      - name: Run vulnix
        run: |
          nix run nixpkgs/nixos-unstable#vulnix -- -w https://raw.githubusercontent.com/ckauhaus/nixos-vulnerability-roundup/master/whitelists/nixos-unstable.toml ./profile | tee security.txt

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flake-health
          path: |
            security.txt
            profile
          if-no-files-found: ignore

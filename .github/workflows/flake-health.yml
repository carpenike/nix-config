name: Flake Health

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

concurrency:
  group: flake-health
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  health:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          ref: main

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21

      - name: Set up Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13
        with:
          use-flakehub: false

      - name: Run flake freshness policy
        uses: DeterminateSystems/flake-checker-action@3164002371bc90729c68af0e24d5aacf20d7c9f6 # v12
        with:
          nixpkgs-keys: nixpkgs,nixpkgs-unstable

      - name: Build forge closure
        run: |
          nix build .#ciSystems.forge \
            --profile ./profile \
            --fallback \
            -v \
            --log-format raw

      - name: Run vulnix
        run: |
          nix run nixpkgs/nixos-unstable#vulnix -- -w https://raw.githubusercontent.com/ckauhaus/nixos-vulnerability-roundup/master/whitelists/nixos-unstable.toml ./profile | tee security.txt

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: flake-health
          path: |
            security.txt
            profile
          if-no-files-found: ignore

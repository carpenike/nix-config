{"id":"nix-config-0oe","title":"Consider lazy trees for faster flake source copying","description":"**Problem**: Nix copies the entire git working tree into the store on every flake operation. For a 122MB repository, this adds overhead.\n\n**Current Behavior**:\n- Every \\`nix build\\`, \\`nix eval\\`, etc. copies source to /nix/store\n- Dirty trees re-copy on every change\n- Large files (even gitignored) can impact copy time\n\n**Potential Solutions**:\n\n1. **Lazy Trees (Experimental)** - Nix PR #6530:\n\\`\\`\\`nix\n# nix.conf\nexperimental-features = nix-command flakes lazy-trees\n\\`\\`\\`\nNote: Still experimental, may have bugs.\n\n2. **Optimize .gitignore**:\nEnsure all build artifacts, caches, and large files are gitignored:\n\\`\\`\\`\nresult\n.direnv/\ntmp/\nsite/\n*.sqlite\n\\`\\`\\`\n\n3. **Use git worktrees for clean builds**:\n\\`\\`\\`bash\n# CI pattern - clean tree = no copy overhead\ngit worktree add /tmp/nix-build\n\\`\\`\\`\n\n**Current Repo Size**: 122MB\n\n**Files to check**:\n- \\`.gitignore\\` - ensure comprehensive\n- \\`.git/info/exclude\\` - local excludes\n- Large directories: result/, site/, tmp/, .direnv/\n\n**Verification**:\n\\`\\`\\`bash\n# Find large untracked files\ngit ls-files --others --exclude-standard | xargs du -sh | sort -h | tail -20\n\\`\\`\\`","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-16T19:51:16.837179-05:00","updated_at":"2025-12-16T19:51:16.837179-05:00"}
{"id":"nix-config-1jf","title":"Deduplicate flake inputs with follows directives","description":"**Problem**: flake.lock has 34 nodes with duplicate transitive inputs.\n\n**COMPLETED** ✅\n\n**Results**:\n- **Before**: 30 non-root nodes\n- **After**: 27 non-root nodes\n- **Reduction**: 3 nodes eliminated (10%)\n\n**Changes Made to \\`flake.nix\\`**:\nAdded follows directives to \\`nix-inspect\\` input:\n\\`\\`\\`nix\ninputs.parts.follows = \"flake-parts\";\ninputs.nci.inputs.nixpkgs.follows = \"nixpkgs\";\ninputs.nci.inputs.parts.follows = \"flake-parts\";\ninputs.nci.inputs.rust-overlay.follows = \"rust-overlay\";\ninputs.nci.inputs.treefmt.inputs.nixpkgs.follows = \"nixpkgs\";\ninputs.nci.inputs.dream2nix.inputs.nixpkgs.follows = \"nixpkgs\";\n\\`\\`\\`\n\n**Duplicates Eliminated**:\n| Original | Duplicate | Resolution |\n|----------|-----------|------------|\n| \\`flake-parts\\` | \\`parts\\`, \\`parts_2\\` | Both now follow \\`flake-parts\\` |\n| \\`rust-overlay\\` | \\`rust-overlay_2\\` | Now follows \\`rust-overlay\\` |\n\n**Could Not Deduplicate** (already optimized or no inputs):\n- \\`purescript-overlay\\`, \\`slimlock\\`, \\`flake-compat\\`, \\`pyproject-nix\\` - leaf deps with no/null inputs\n- \\`crane\\`, \\`mk-naked-shell\\` - pure flakes with no inputs\n- \\`catppuccin\\` - no inputs\n- Existing follows for \\`home-manager\\`, \\`disko\\`, \\`sops-nix\\`, \\`nixvim\\`, etc. were already well-optimized\n\n**Files Modified**:\n- \\`flake.nix\\`\n- \\`flake.lock\\` (regenerated)\n\n**Verification**: \\`nix eval .#nixosConfigurations.forge.config.system.build.toplevel.name\\` ✅","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-16T19:50:45.63951-05:00","updated_at":"2025-12-16T20:16:20.325729-05:00","closed_at":"2025-12-16T20:15:15.419728-05:00"}
{"id":"nix-config-1pr","title":"Refactor storage-helpers circular dependency pattern","description":"Refactor the storage-helpers circular dependency workarounds found throughout the codebase (~20+ instances).\n\n## The problem\nServices use a workaround pattern to avoid circular dependencies when accessing \\`mylib.storageHelpers\\`:\n\\`\\`\\`nix\n# Passed in to avoid circular dependencies in module evaluation\nmkStorageDependencies = config.mylib.storageHelpers.mkStorageDependencies;\n\\`\\`\\`\n\n## Affected files (grep for 'circular' or 'mkStorageDependencies')\n- \\`modules/nixos/services/sonarr/default.nix\\`\n- \\`modules/nixos/services/radarr/default.nix\\`\n- \\`modules/nixos/services/prowlarr/default.nix\\`\n- \\`modules/nixos/services/sabnzbd/default.nix\\`\n- \\`modules/nixos/services/lidarr/default.nix\\`\n- \\`modules/nixos/services/readarr/default.nix\\`\n- \\`modules/nixos/services/bazarr/default.nix\\`\n- \\`modules/nixos/services/qbittorrent/default.nix\\`\n- \\`modules/nixos/services/postgresql/storage-integration.nix\\`\n- \\`modules/nixos/services/postgresql/databases.nix\\`\n- \\`modules/nixos/services/github-runner/default.nix\\`\n- \\`hosts/forge/services/monitoring-hub.nix\\`\n- And others - run: \\`rg -l 'circular|mkStorageDependencies' modules/\\`\n\n## Root cause\n\\`lib/default.nix\\` exposes \\`mylib\\` which includes \\`storageHelpers\\`. When modules try to access \\`config.mylib.storageHelpers\\` during option definition (not config evaluation), it creates a cycle.\n\n## Potential solutions\n1. Move storageHelpers to a separate module that's imported earlier\n2. Use \\`lib.mkDefault\\` or \\`lib.mkOverride\\` patterns\n3. Restructure so helpers don't depend on config\n4. Related to lazy loading - if modules are loaded lazily, the cycle may resolve naturally\n\n## Documentation updates (do alongside implementation)\n- [ ] Document the resolved pattern in \\`docs/modular-design-patterns.md\\`\n- [ ] Remove/update any docs that reference the workaround pattern\n- [ ] Add ADR if the solution involves architectural changes\n\n## Verification\n\\`\\`\\`bash\nnix flake check\nnix build .#nixosConfigurations.forge.config.system.build.toplevel\n\\`\\`\\`","acceptance_criteria":"- Remove the PostgreSQL circular-dep FIXME and eliminate the recursion/cycle\\n- `nix flake check` succeeds\\n- `nix build .#ciSystems.forge` succeeds\\n- Postgres-dependent integrations (alerts/datasources/backups) still evaluate","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-16T14:40:04.239419-05:00","updated_at":"2025-12-16T17:21:28.584012-05:00","closed_at":"2025-12-16T17:21:28.584012-05:00"}
{"id":"nix-config-2m7","title":"Audit and optimize overlay evaluation","description":"**Problem**: Every NixOS configuration evaluates all overlays, including the unstable-packages overlay which imports the entire nixpkgs-unstable.\n\n**Current State** (\\`overlays/default.nix\\`):\n\\`\\`\\`nix\n{\n  rust-overlay = inputs.rust-overlay.overlays.default;\n  \n  additions = final: _prev: import ../pkgs { ../.. };\n  \n  # This imports ALL of nixpkgs-unstable on every evaluation\n  unstable-packages = final: _prev: {\n    unstable = import inputs.nixpkgs-unstable {\n      system = final.stdenv.hostPlatform.system;\n      config.allowUnfree = true;\n      overlays = [ ../.. ];\n    };\n  };\n}\n\\`\\`\\`\n\n**Impact**: The \\`import inputs.nixpkgs-unstable\\` is evaluated even if \\`pkgs.unstable.*\\` is never used.\n\n**Proposed Optimizations**:\n\n1. **Make unstable lazy** (if not already):\n\\`\\`\\`nix\nunstable-packages = final: _prev: {\n  unstable = let\n    # Only evaluate when accessed\n    pkgs = import inputs.nixpkgs-unstable { ../.. };\n  in pkgs;\n};\n\\`\\`\\`\n\n2. **Consider removing unused overlays**:\n- Is rust-overlay actually used?\n- Are all additions packages needed?\n\n3. **Profile overlay impact**:\n\\`\\`\\`bash\n# Compare with/without overlays\ntime nix eval .#nixosConfigurations.forge.config.system.build.toplevel.name\n\\`\\`\\`\n\n**Files to audit**:\n- \\`overlays/default.nix\\`\n- \\`pkgs/\\` directory - check what's actually imported\n\n**Verification**:\n\\`\\`\\`bash\n# Search for pkgs.unstable usage\ngrep -r 'pkgs.unstable' modules/ hosts/\n\\`\\`\\`","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-16T19:51:28.142683-05:00","updated_at":"2025-12-16T19:51:28.142683-05:00"}
{"id":"nix-config-58b","title":"Implement lazy module loading for service modules","description":"Implement lazy module loading so hosts only import the module sets they actually need.\n\n## Goal\nInstead of every host importing all 104 service modules, each host imports only the categories it uses.\n\n## Current architecture\n\\`lib/mkSystem.nix\\` creates NixOS configurations:\n\\`\\`\\`nix\n# Every host gets ALL modules\nmodules = [\n  ../modules/nixos  # This pulls in everything\n  # host-specific stuff\n];\n\\`\\`\\`\n\n## Proposed architecture\n\\`\\`\\`nix\n# In lib/mkSystem.nix or host config\nmodules = [\n  ../modules/nixos/core           # Always needed\n  ../modules/nixos/services/_categories/media    # Only if host uses media\n  ../modules/nixos/services/_categories/infra    # Only if host uses infra\n  # host-specific stuff\n];\n\\`\\`\\`\n\n## Key files\n- \\`lib/mkSystem.nix\\` - NixOS configuration builder\n- \\`modules/nixos/default.nix\\` - current monolithic import\n- \\`hosts/*/default.nix\\` - host configurations\n\n## Dependencies\n- Requires nix-config-ehw (categories must exist first)\n- Requires nix-config-1pr (circular deps block selective imports)\n\n## Implementation approach\n1. Add \\`moduleCategories\\` parameter to \\`mkSystem\\`\n2. Default to all categories (backward compatible)\n3. Allow hosts to override with specific list\n4. Test with forge first\n\n## Documentation updates (do alongside implementation)\n- [ ] Update \\`docs/repository-architecture.md\\` Import Flow section\n- [ ] Add lazy loading example to \\`docs/modular-design-patterns.md\\`\n- [ ] Update any docs referencing \\`modules/nixos/default.nix\\` monolithic import\n\n## Verification\n\\`\\`\\`bash\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel\n# Should show reduced eval time/derivations vs baseline\n\\`\\`\\`","acceptance_criteria":"- A host can build without importing the entire `modules/nixos/default.nix` surface\\n- `nix build .#ciSystems.forge` still works\\n- Evaluation stats improve or stay flat vs baseline","notes":"All deployed hosts now use selective category loading. Performance results: rydev 11.60s (66% faster), luna 13.65s (60% faster), nixpi 18s (51% faster) vs forge baseline 33.89s. nas-0/nas-1 not yet deployed so left with default all-categories loading.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-16T14:26:37.33809-05:00","updated_at":"2025-12-16T16:49:26.417046-05:00","closed_at":"2025-12-16T16:49:26.417059-05:00","dependencies":[{"issue_id":"nix-config-58b","depends_on_id":"nix-config-1pr","type":"blocks","created_at":"2025-12-16T14:41:12.123453-05:00","created_by":"daemon"},{"issue_id":"nix-config-58b","depends_on_id":"nix-config-ehw","type":"blocks","created_at":"2025-12-16T14:53:43.400022-05:00","created_by":"daemon"}]}
{"id":"nix-config-5i2","title":"Evaluate nixos-unified or flake-parts autowiring","description":"Research whether nixos-unified or flake-parts autowiring would help this repo.\n\n## Context\nThis repo uses flake-parts already. The question is whether adopting autowiring patterns (automatic module/package discovery) would:\n1. Reduce boilerplate\n2. Support lazy loading goals\n3. Not increase evaluation cost\n\n## Research tasks\n1. Review nixos-unified: https://github.com/srid/nixos-unified\n2. Review flake-parts autowiring patterns\n3. Compare to current \\`pkgs/default.nix\\` (17 packages, manual callPackage)\n4. Compare to current \\`modules/nixos/default.nix\\` (104 services, manual imports)\n\n## Key questions\n- Does autowiring support selective/lazy imports?\n- What's the eval-time cost of directory scanning?\n- Does it play well with the category-based imports from nix-config-ehw?\n\n## Current state (for comparison)\n\\`\\`\\`bash\n# Packages - manual\nls pkgs/  # ~17 packages\n\n# Modules - manual\nls modules/nixos/services/ | wc -l  # ~104 services\n\\`\\`\\`\n\n## Decision criteria\n- **Go**: Demonstrable boilerplate reduction + no eval regression\n- **No-go**: Eval cost increase OR conflicts with lazy loading goals\n\n## Output\nRecord decision in issue notes with rationale. If go, create follow-up implementation issue.","acceptance_criteria":"- Clear go/no-go decision recorded\\n- If go: a small pilot proves it reduces boilerplate without increasing eval cost\\n- If no-go: rationale documented","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-16T14:27:48.246715-05:00","updated_at":"2025-12-16T19:43:56.113589-05:00","closed_at":"2025-12-16T19:43:56.113589-05:00","dependencies":[{"issue_id":"nix-config-5i2","depends_on_id":"nix-config-58b","type":"blocks","created_at":"2025-12-16T14:41:12.205121-05:00","created_by":"daemon"}]}
{"id":"nix-config-6m8","title":"Enable nix-eval-jobs or nix-fast-build for CI","description":"**Problem**: \\`nix flake check\\` and \\`nix build\\` evaluate targets sequentially, not leveraging parallelism.\n\n**Current CI Pattern**:\nSequential evaluation of each nixosConfiguration.\n\n**Proposed Solution**: Use \\`nix-eval-jobs\\` or \\`nix-fast-build\\` for parallel evaluation and building.\n\n**nix-fast-build**:\n\\`\\`\\`bash\n# Parallel eval + build\nnix-fast-build --flake .#checks\nnix-fast-build --flake .#nixosConfigurations\n\\`\\`\\`\n\n**nix-eval-jobs**:\n\\`\\`\\`bash\n# Lower level - parallel evaluation\nnix-eval-jobs --flake .#nixosConfigurations | jq\n\\`\\`\\`\n\n**Implementation Options**:\n\n1. **Add to devShell**:\n\\`\\`\\`nix\ndevShells.default = pkgs.mkShell {\n  packages = with pkgs; [\n    nix-eval-jobs\n    nix-fast-build\n  ];\n};\n\\`\\`\\`\n\n2. **Update Taskfile**:\n\\`\\`\\`yaml\ntasks:\n  ci:build-all:\n    cmds:\n      - nix-fast-build --flake .#ciSystems\n\\`\\`\\`\n\n**Files to modify**:\n- \\`flake.nix\\` - add to devShell\n- \\`Taskfile.yaml\\` - add fast-build task\n- \\`.github/workflows/\\` - if GitHub Actions used\n\n**Verification**:\n\\`\\`\\`bash\ntime nix-fast-build --flake .#ciSystems\n# vs\ntime nix build .#ciSystems.forge .#ciSystems.luna ../..\n\\`\\`\\`","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-16T19:51:38.205717-05:00","updated_at":"2025-12-16T19:51:38.205717-05:00"}
{"id":"nix-config-8to","title":"Split lib/types.nix into smaller focused files","description":"Split lib/types.nix into smaller, focused files for maintainability.\n\n## Current state\n\\`lib/types.nix\\` contains ALL shared type definitions:\n\\`\\`\\`bash\nwc -l lib/types.nix  # Check line count\nhead -100 lib/types.nix  # See structure\n\\`\\`\\`\n\n## Proposed structure\n\\`\\`\\`\nlib/\n├── types/\n│   ├── default.nix       # Re-exports all types (backward compat)\n│   ├── reverse-proxy.nix # reverseProxySubmodule\n│   ├── metrics.nix       # metricsSubmodule  \n│   ├── logging.nix       # loggingSubmodule\n│   ├── backup.nix        # backupSubmodule\n│   ├── storage.nix       # datasetSubmodule, storageTypes\n│   ├── container.nix     # containerResourcesSubmodule\n│   └── healthcheck.nix   # healthcheckSubmodule\n└── types.nix             # Deprecated, imports from types/default.nix\n\\`\\`\\`\n\n## Implementation steps\n1. Create \\`lib/types/\\` directory\n2. Move each submodule type to its own file\n3. Create \\`lib/types/default.nix\\` that imports and re-exports all\n4. Update \\`lib/types.nix\\` to just import from \\`lib/types/default.nix\\`\n5. Verify no breakage\n\n## Key files\n- \\`lib/types.nix\\` - current monolithic file\n- \\`lib/default.nix\\` - exports mylib.types\n\n## Documentation updates (do alongside implementation)\n- [ ] Update \\`docs/modular-design-patterns.md\\` Shared Types Library section\n- [ ] Update \\`docs/repository-architecture.md\\` lib/ directory structure\n- [ ] Update import examples in prompts/agents if they reference \\`lib/types.nix\\` directly\n\n## Verification\n\\`\\`\\`bash\nnix flake check\nnix build .#nixosConfigurations.forge.config.system.build.toplevel\n# Grep for type usage to ensure nothing broke\nrg 'sharedTypes\\.' modules/\n\\`\\`\\`","acceptance_criteria":"- Types are split into coherent files (e.g., reverseProxy, metrics, logging, backup, storage)\\n- No call sites break\\n- `nix flake check` passes","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-16T14:27:14.707507-05:00","updated_at":"2025-12-16T19:34:46.255521-05:00","closed_at":"2025-12-16T19:34:46.255521-05:00"}
{"id":"nix-config-8v5","title":"Add nix garbage collection configuration","description":"Add Nix garbage collection configuration to prevent disk bloat while preserving rollback capability.\n\n## Current state\nCheck current GC config:\n\\`\\`\\`bash\n# On a NixOS host\ngrep -r 'gc' /etc/nixos/ || echo 'No GC config found'\nnix-store --gc --print-dead | wc -l  # How much garbage?\n\\`\\`\\`\n\n## Recommended configuration\nAdd to a shared module or host config:\n\\`\\`\\`nix\n# modules/nixos/common/nix.nix or similar\nnix.gc = {\n  automatic = true;\n  dates = \"weekly\";\n  options = \"--delete-older-than 30d\";\n};\n\n# Keep N generations for rollback\nnix.settings.keep-outputs = true;\nnix.settings.keep-derivations = true;\n\n# For NixOS specifically\nsystem.autoUpgrade.allowReboot = false;  # Don't auto-reboot\n\\`\\`\\`\n\n## For Darwin (rymac)\n\\`\\`\\`nix\n# modules/darwin/nix.nix or similar\nnix.gc = {\n  automatic = true;\n  interval = { Weekday = 0; Hour = 2; Minute = 0; };\n  options = \"--delete-older-than 30d\";\n};\n\\`\\`\\`\n\n## Key files to check/modify\n- \\`modules/nixos/common/nix.nix\\` - if exists\n- \\`modules/darwin/nix.nix\\` - for macOS\n- \\`profiles/\\` - might have nix settings\n\n## Verification\n\\`\\`\\`bash\n# After applying\nsystemctl list-timers | grep gc\nnix-store --gc --print-dead | head -20\n\\`\\`\\`\n\n## Documentation\nAdd to README or docs/ explaining:\n- GC schedule\n- How many generations kept\n- How to manually trigger GC\n- How to rollback if needed","acceptance_criteria":"- GC policy is defined (schedule + retention)\\n- Works for at least one NixOS host and Darwin if applicable\\n- Documented in README/docs","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-16T14:26:55.63519-05:00","updated_at":"2025-12-16T17:17:03.060831-05:00","closed_at":"2025-12-16T17:17:03.060831-05:00"}
{"id":"nix-config-as6","title":"Pin nixpkgs to specific channel for faster registry lookups","description":"**Problem**: Using latest nixpkgs branch can cause slower evaluation due to registry lookups and tarball fetching on first access.\n\n**Current State**:\n\\`\\`\\`nix\nnixpkgs.url = \"github:NixOS/nixpkgs/nixos-25.11\";\n\\`\\`\\`\n\n**Best Practice Options**:\n\n1. **Pin to specific commit** (fastest, most reproducible):\n\\`\\`\\`nix\nnixpkgs.url = \"github:NixOS/nixpkgs/SPECIFIC_COMMIT_HASH\";\n\\`\\`\\`\n\n2. **Use flake registry pinning** (system-wide benefit):\n\\`\\`\\`nix\n# In modules/common/nix.nix\nnix.registry.nixpkgs.flake = nixpkgs;\n\\`\\`\\`\n\nThis ensures \\`nix shell nixpkgs#\u003cpkg\u003e\\` uses the same pinned version, avoiding re-downloads.\n\n**Files to modify**:\n- \\`modules/common/nix.nix\\` - add registry pinning\n- \\`flake.nix\\` - consider commit pinning (optional, tradeoff with freshness)\n\n**Benefits**:\n- Faster \\`nix shell\\`/\\`nix run\\` commands\n- Consistent nixpkgs version across all nix commands\n- Avoids downloading duplicate nixpkgs tarballs\n\n**Verification**:\n\\`\\`\\`bash\n# After change, this should be instant (no download)\ntime nix shell nixpkgs#hello -c hello\n\\`\\`\\`","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-16T19:50:55.857022-05:00","updated_at":"2025-12-16T19:50:55.857022-05:00"}
{"id":"nix-config-dig","title":"Profile evaluation with NIX_SHOW_STATS","description":"Establish an evaluation-performance baseline before any import refactoring work begins.\n\n## Commands to run\n\\`\\`\\`bash\n# Primary benchmark - forge is the heaviest host\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel 2\u003e\u00261 | tee eval-baseline.txt\n\n# Quick check (no build, just eval)\ntime nix eval .#nixosConfigurations.forge.config.system.build.toplevel --raw 2\u003e/dev/null\n\\`\\`\\`\n\n## Key files\n- \\`modules/nixos/default.nix\\` - current monolithic import (104 service modules)\n- \\`lib/mkSystem.nix\\` - where modules get wired into hosts\n- \\`hosts/forge/default.nix\\` - heaviest host config\n\n## What to record\n- Total evaluation time\n- Number of derivations\n- Memory usage if available\n- Copy these stats into the issue notes field\n\n## Success criteria\nBaseline recorded. This issue is complete once we have numbers to compare against.","acceptance_criteria":"- Baseline eval stats recorded in the issue notes\\n- After refactors, rerun the same command(s) and record deltas\\n- Any major regressions are called out","notes":"## Baseline Results (2025-12-16)\n\n### Quick Eval Timing\n- **Wall time**: 41.43 seconds\n- **CPU time**: 17.30 seconds (user) + 2.16 seconds (sys)\n\n### NIX_SHOW_STATS Output\n| Metric | Value |\n|--------|-------|\n| CPU Time | 17.85s |\n| GC Time | 5.75s (32% of total) |\n| Heap Size | 1.85 GB |\n| Total GC Bytes | 2.80 GB |\n| Function Calls | 21.6M |\n| Thunks | 31.2M |\n| Values | 41.3M |\n| Sets | 6.1M (77.5M elements) |\n| Envs | 24.8M |\n| Expressions | 2.9M |\n\n### Module Counts\n- Service modules: 104\n- Total NixOS modules: 137\n- Forge service files: 60\n\n### Key Observations\n1. **GC pressure is high** - 32% of eval time in garbage collection\n2. **Set operations dominate** - 77M set elements, 54M values copied in updates\n3. **Many thunks** - 31M thunks suggests heavy lazy evaluation\n4. **Large heap** - 1.85GB heap for a single host config\n\n### Comparison Targets\nAfter refactoring (ehw, 58b, 1pr), re-run these commands:\n\\`\\`\\`bash\ntime nix eval .#nixosConfigurations.forge.config.system.build.toplevel --raw\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel --dry-run\n\\`\\`\\`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T14:27:05.645911-05:00","updated_at":"2025-12-16T15:24:45.825208-05:00","closed_at":"2025-12-16T15:24:45.825208-05:00"}
{"id":"nix-config-ec7","title":"Add parallel evaluation and build settings to nix.nix","description":"**Problem**: Current nix daemon settings don't optimize for parallel evaluation or builds.\n\n**COMPLETED** ✅\n\n**Changes Made**:\n- Added \\`keep-going = true\\` to \\`modules/common/nix.nix\\`\n\n**Already Present** (no changes needed):\n- \\`max-jobs = \"auto\"\\` ✅\n- \\`cores = 0\\` ✅\n- \\`http2 = true\\` ✅\n- \\`log-lines = 25\\` ✅\n\n**GC Settings Analysis**:\nThe GC settings are intentionally split for platform compatibility:\n- \\`modules/common/nix.nix\\`: \\`automatic = true\\`, \\`options = \"--delete-older-than 30d\"\\` (cross-platform)\n- \\`modules/nixos/nix.nix\\`: \\`dates = \"weekly\"\\` (NixOS-specific; Darwin uses \\`interval\\`)\n\nThis split is **correct** - consolidating would break Darwin compatibility.\n\n**Files Modified**:\n- \\`modules/common/nix.nix\\` - Added \\`keep-going = true\\`\n\n**Verification**: \n- \\`nix eval .#nixosConfigurations.forge.config.nix.settings\\` ✅\n- \\`nix eval .#nixosConfigurations.forge.config.nix.gc\\` ✅","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-16T19:50:34.682599-05:00","updated_at":"2025-12-16T20:16:08.078304-05:00","closed_at":"2025-12-16T20:15:15.381614-05:00"}
{"id":"nix-config-ehw","title":"Split service modules into category-based imports","description":"Split service modules into category-based imports so hosts can import only what they need.\n\n## Current structure\n\\`modules/nixos/default.nix\\` imports ALL 104 service modules unconditionally:\n\\`\\`\\`nix\nimports = [\n  ./services/sonarr\n  ./services/radarr\n  ./services/plex\n  # ../.. 101 more services\n];\n\\`\\`\\`\n\n## Proposed structure\nCreate category files in \\`modules/nixos/services/\\`:\n\\`\\`\\`\nmodules/nixos/services/\n├── _categories/\n│   ├── media.nix      # sonarr, radarr, plex, jellyfin, etc.\n│   ├── downloads.nix  # sabnzbd, qbittorrent, prowlarr\n│   ├── infra.nix      # caddy, postgresql, redis\n│   ├── observability.nix  # grafana, loki, prometheus\n│   ├── auth.nix       # pocketid, keycloak\n│   ├── storage.nix    # zfs, sanoid, nfs\n│   └── home.nix       # home-assistant, esphome, zigbee2mqtt\n├── default.nix        # imports all categories (backward compat)\n└── [individual services...]\n\\`\\`\\`\n\n## Implementation steps\n1. Identify which services belong to which category (review \\`hosts/forge/services/\\`)\n2. Create category import files\n3. Update \\`modules/nixos/default.nix\\` to import categories\n4. Test that \\`nix build .#nixosConfigurations.forge...\\` still works\n\n## Key files to modify\n- \\`modules/nixos/default.nix\\` - main entry point\n- \\`modules/nixos/services/default.nix\\` - service imports\n- Create new \\`modules/nixos/services/_categories/*.nix\\` files\n\n## Documentation updates (do alongside implementation)\n- [ ] Update \\`docs/repository-architecture.md\\` directory structure diagram\n- [ ] Update \\`.github/copilot-instructions.md\\` Repository Architecture section\n- [ ] Update \\`.github/prompts/nixos/service-module.prompt.md\\` Pattern Discovery Phase\n- [ ] Update \\`.github/agents/nixos-service-scaffold.agent.md\\` with category guidance\n- [ ] Update \\`.github/instructions/nixos-instructions.md\\` Module Development Workflow\n\n## Verification\n\\`\\`\\`bash\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel\n# Compare to baseline from nix-config-dig\n\\`\\`\\`","acceptance_criteria":"- Category import files exist and are used by at least one host\\n- No service behavior changes (pure refactor)\\n- Evaluation stats do not regress","notes":"Categories implemented. 13 category files created under modules/nixos/services/_categories/. Removed privatebin (empty dir). All configs pass nix flake check. Timing: 31.5s (baseline 41.4s - no regression).","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-16T14:26:46.466962-05:00","updated_at":"2025-12-16T15:33:38.171592-05:00","closed_at":"2025-12-16T15:33:38.171592-05:00","dependencies":[{"issue_id":"nix-config-ehw","depends_on_id":"nix-config-dig","type":"blocks","created_at":"2025-12-16T14:40:55.097348-05:00","created_by":"daemon"}]}
{"id":"nix-config-f02","title":"Centralize storageHelpers imports via mylib injection","description":"**Problem**: ~20+ service modules each individually import \\`../../storage/helpers-lib.nix\\`, causing redundant file parsing during evaluation.\n\n**COMPLETED** ✅\n\n**Changes Made**:\n- Modified \\`lib/default.nix\\` to add \\`storageHelpers\\` to mylib\n- Modified \\`lib/mkSystem.nix\\` to pass pkgs to storageHelpers\n- Updated **50+ service modules** to use \\`mylib.storageHelpers\\` instead of direct imports\n\n**Files Modified**:\n- \\`lib/default.nix\\`\n- \\`lib/mkSystem.nix\\`\n- \\`modules/nixos/services/attic.nix\\`\n- \\`modules/nixos/services/autobrr/default.nix\\`\n- \\`modules/nixos/services/bazarr/default.nix\\`\n- \\`modules/nixos/services/bichon/default.nix\\`\n- \\`modules/nixos/services/cooklang-federation/default.nix\\`\n- \\`modules/nixos/services/cooklang/default.nix\\`\n- \\`modules/nixos/services/cross-seed/default.nix\\`\n- \\`modules/nixos/services/dispatcharr/default.nix\\`\n- ../.. and 40+ more service modules\n\n**Verification**: \\`nix eval .#nixosConfigurations.forge.config.system.build.toplevel.name\\` passes\n\n**Impact**: Reduced redundant file parsing from ~50 imports to 1 centralized import","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-16T19:50:24.934902-05:00","updated_at":"2025-12-16T20:15:59.356434-05:00","closed_at":"2025-12-16T20:15:15.343013-05:00"}
{"id":"nix-config-gzk","title":"Consider host-specific module imports","description":"Each host should explicitly declare which module categories it needs, rather than importing everything.\n\n## Current state\nHosts implicitly get all modules via \\`lib/mkSystem.nix\\`:\n\\`\\`\\`nix\n# hosts/forge/default.nix\n{ ../.. }: {\n  imports = [ ./services ./core ./infrastructure ];\n  # Gets ALL service modules even if only using 20\n}\n\\`\\`\\`\n\n## Proposed state\n\\`\\`\\`nix\n# hosts/forge/default.nix\n{ ../.. }: {\n  imports = [ ./services ./core ./infrastructure ];\n  \n  # Explicit category selection\n  modules.categories = [ \"media\" \"downloads\" \"infra\" \"observability\" \"home\" ];\n}\n\\`\\`\\`\n\nOr directly in mkSystem call:\n\\`\\`\\`nix\n# In flake.nix or lib/mkSystem.nix\nmkSystem {\n  host = \"forge\";\n  categories = [ \"media\" \"downloads\" \"infra\" \"observability\" \"home\" ];\n}\n\\`\\`\\`\n\n## Key files\n- \\`hosts/forge/default.nix\\` - pilot host\n- \\`hosts/luna/default.nix\\` - secondary test (simpler host)\n- \\`lib/mkSystem.nix\\` - needs to support category selection\n\n## Dependencies\n- Requires nix-config-ehw (categories defined)\n- Informed by nix-config-dig (baseline comparison)\n\n## Verification\n1. Pick a simple host (luna or nixpi)\n2. Define explicit category list\n3. Verify build succeeds\n4. Verify no orphaned contributions (alerts, datasets) when service disabled","acceptance_criteria":"- At least one host switches to host-specific imports\\n- Host still builds and deploys\\n- No orphaned infrastructure contributions when a service is disabled","notes":"Implemented selective category loading in mkSystem.nix. nixpi now loads only infrastructure+observability (2 categories). Results: 18.35s vs 37.84s for forge (51% reduction). Also fixed anti-pattern where grafana-oncall and pinchflat were auto-contributing to homepage/gatus.","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-16T14:27:39.032908-05:00","updated_at":"2025-12-16T16:38:09.92787-05:00","closed_at":"2025-12-16T16:38:09.927887-05:00","dependencies":[{"issue_id":"nix-config-gzk","depends_on_id":"nix-config-ehw","type":"blocks","created_at":"2025-12-16T14:28:02.466899-05:00","created_by":"daemon"},{"issue_id":"nix-config-gzk","depends_on_id":"nix-config-dig","type":"blocks","created_at":"2025-12-16T14:40:55.131661-05:00","created_by":"daemon"}]}
{"id":"nix-config-mla","title":"Add flake input version pinning documentation","description":"Document the flake input version pinning policy and update workflow.\n\n## What to document\n1. **Input sources** - which inputs use stable vs unstable nixpkgs\n2. **Update cadence** - how often inputs are updated\n3. **Renovate integration** - how Renovate PRs fit in\n4. **Rollback procedure** - how to revert a bad update\n\n## Key files to reference\n- \\`flake.nix\\` - input definitions\n- \\`flake.lock\\` - pinned versions\n- \\`.github/workflows/update-flake-lock.yml\\` - automation\n- \\`Taskfile.yaml\\` - manual commands\n\n## Taskfile commands to document\n\\`\\`\\`bash\ntask --list | grep -i flake  # Find relevant tasks\n# Likely includes:\n# task nix:update-flake\n# task nix:update-input INPUT=nixpkgs\n\\`\\`\\`\n\n## Suggested doc location\n\\`docs/flake-management.md\\` or add section to \\`README.md\\`\n\n## Content outline\n\\`\\`\\`markdown\n# Flake Input Management\n\n## Inputs Overview\n| Input | Channel | Purpose |\n|-------|---------|---------|\n| nixpkgs | nixos-25.11 | Stable packages |\n| nixpkgs-unstable | nixos-unstable | Bleeding edge |\n| home-manager | release-25.11 | User environment |\n| ../.. | ../.. | ../.. |\n\n## Update Workflow\n1. Renovate creates PRs for container updates\n2. \\`task nix:update-flake\\` updates all inputs\n3. CI builds and tests\n\n## Manual Update\n\\`\\`\\`bash\ntask nix:update-flake\n# or specific input\nnix flake lock --update-input nixpkgs\n\\`\\`\\`\n\n## Rollback\n\\`\\`\\`bash\ngit checkout HEAD~1 -- flake.lock\nnix flake lock --no-update-lock-file\n\\`\\`\\`\n\\`\\`\\`\n\n## Note\nThis issue can be done independently of the architectural refactors (ehw, 58b, 8to, 1pr). However, if the lazy loading work changes how inputs are consumed, this doc may need updates.","acceptance_criteria":"- Docs describe update workflow and pinning rationale\\n- References Taskfile commands used in this repo","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-16T14:27:31.824177-05:00","updated_at":"2025-12-16T19:38:33.682437-05:00","closed_at":"2025-12-16T19:38:33.682437-05:00"}
{"id":"nix-config-rfq","title":"Remove redundant nix.gc configuration","description":"**Problem**: nix.gc is configured in two places with conflicting/redundant settings.\n\n**Location 1** - \\`modules/nixos/nix.nix\\`:\n\\`\\`\\`nix\n_: {\n  nix.gc = {\n    dates = \"weekly\";\n  };\n}\n\\`\\`\\`\n\n**Location 2** - \\`modules/common/nix.nix\\`:\n\\`\\`\\`nix\nnix = {\n  gc = {\n    automatic = true;\n    options = \"--delete-older-than 30d\";\n  };\n};\n\\`\\`\\`\n\n**Impact**: Confusing configuration, potential for NixOS module merge conflicts.\n\n**Proposed Fix**: Consolidate all nix settings into \\`modules/common/nix.nix\\` and make \\`modules/nixos/nix.nix\\` NixOS-specific only (or remove if empty).\n\n**Files to modify**:\n- \\`modules/nixos/nix.nix\\` - remove or make NixOS-specific only\n- \\`modules/common/nix.nix\\` - ensure all GC settings are here\n\n**Verification**:\n\\`\\`\\`bash\nnix eval .#nixosConfigurations.forge.config.nix.gc\n\\`\\`\\`","status":"open","priority":3,"issue_type":"bug","created_at":"2025-12-16T19:51:03.665584-05:00","updated_at":"2025-12-16T19:51:03.665584-05:00"}
{"id":"nix-config-rkq","title":"Avoid builtins.readFile at module level where possible","description":"**Problem**: Using \\`builtins.readFile\\` at module evaluation time forces file reads during every nix evaluation.\n\n**Current Usages Found**:\n\\`\\`\\`\nhosts/nixpi/default.nix:75 - SSH keys\nhosts/forge/core/users.nix:16 - SSH keys  \nhosts/nixos-bootstrap/default.nix:60 - SSH keys\nhosts/luna/config/blocky.nix:69 - blocky config\nhosts/rydev/default.nix:35 - SSH keys\nhosts/luna/default.nix:45 - SSH keys\nhosts/rymac/default.nix:18 - SSH keys\nmodules/nixos/services/postgresql/default.nix:146 - SQL snippets\n\\`\\`\\`\n\n**Impact Analysis**:\n- SSH key reads: Minimal impact (small files, needed at eval time)\n- SQL snippets: Could be moved to build time if large\n- blocky config: Depends on size/complexity\n\n**Proposed Actions**:\n\n1. **SSH keys**: Keep as-is (necessary for user config)\n\n2. **SQL snippets**: Consider using \\`pkgs.writeText\\` to defer to build time:\n\\`\\`\\`nix\n# Instead of\nbuiltins.readFile ./sql/seed.sql\n# Use\n\\\\{pkgs.writeText \"seed.sql\" (builtins.readFile ./sql/seed.sql)}\n\\`\\`\\`\nNote: Only helps if the readFile result isn't needed during eval.\n\n3. **Audit for large files**: Check if any readFile targets are large.\n\n**Verification**:\n\\`\\`\\`bash\n# Check sizes of files being read\nwc -c home/ryan/config/ssh/ssh.pub\nls -la hosts/luna/config/services/\n\\`\\`\\`\n\n**Note**: This is a micro-optimization - prioritize only if files are large or eval time is critical.","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-16T19:51:52.597606-05:00","updated_at":"2025-12-16T19:51:52.597606-05:00"}

{"id":"nix-config-1pr","title":"Refactor storage-helpers circular dependency pattern","description":"Refactor the storage-helpers circular dependency workarounds found throughout the codebase (~20+ instances).\n\n## The problem\nServices use a workaround pattern to avoid circular dependencies when accessing \\`mylib.storageHelpers\\`:\n\\`\\`\\`nix\n# Passed in to avoid circular dependencies in module evaluation\nmkStorageDependencies = config.mylib.storageHelpers.mkStorageDependencies;\n\\`\\`\\`\n\n## Affected files (grep for 'circular' or 'mkStorageDependencies')\n- \\`modules/nixos/services/sonarr/default.nix\\`\n- \\`modules/nixos/services/radarr/default.nix\\`\n- \\`modules/nixos/services/prowlarr/default.nix\\`\n- \\`modules/nixos/services/sabnzbd/default.nix\\`\n- \\`modules/nixos/services/lidarr/default.nix\\`\n- \\`modules/nixos/services/readarr/default.nix\\`\n- \\`modules/nixos/services/bazarr/default.nix\\`\n- \\`modules/nixos/services/qbittorrent/default.nix\\`\n- \\`modules/nixos/services/postgresql/storage-integration.nix\\`\n- \\`modules/nixos/services/postgresql/databases.nix\\`\n- \\`modules/nixos/services/github-runner/default.nix\\`\n- \\`hosts/forge/services/monitoring-hub.nix\\`\n- And others - run: \\`rg -l 'circular|mkStorageDependencies' modules/\\`\n\n## Root cause\n\\`lib/default.nix\\` exposes \\`mylib\\` which includes \\`storageHelpers\\`. When modules try to access \\`config.mylib.storageHelpers\\` during option definition (not config evaluation), it creates a cycle.\n\n## Potential solutions\n1. Move storageHelpers to a separate module that's imported earlier\n2. Use \\`lib.mkDefault\\` or \\`lib.mkOverride\\` patterns\n3. Restructure so helpers don't depend on config\n4. Related to lazy loading - if modules are loaded lazily, the cycle may resolve naturally\n\n## Documentation updates (do alongside implementation)\n- [ ] Document the resolved pattern in \\`docs/modular-design-patterns.md\\`\n- [ ] Remove/update any docs that reference the workaround pattern\n- [ ] Add ADR if the solution involves architectural changes\n\n## Verification\n\\`\\`\\`bash\nnix flake check\nnix build .#nixosConfigurations.forge.config.system.build.toplevel\n\\`\\`\\`","acceptance_criteria":"- Remove the PostgreSQL circular-dep FIXME and eliminate the recursion/cycle\\n- `nix flake check` succeeds\\n- `nix build .#ciSystems.forge` succeeds\\n- Postgres-dependent integrations (alerts/datasources/backups) still evaluate","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-16T14:40:04.239419-05:00","updated_at":"2025-12-16T15:18:25.278666-05:00"}
{"id":"nix-config-58b","title":"Implement lazy module loading for service modules","description":"Implement lazy module loading so hosts only import the module sets they actually need.\n\n## Goal\nInstead of every host importing all 104 service modules, each host imports only the categories it uses.\n\n## Current architecture\n\\`lib/mkSystem.nix\\` creates NixOS configurations:\n\\`\\`\\`nix\n# Every host gets ALL modules\nmodules = [\n  ../modules/nixos  # This pulls in everything\n  # host-specific stuff\n];\n\\`\\`\\`\n\n## Proposed architecture\n\\`\\`\\`nix\n# In lib/mkSystem.nix or host config\nmodules = [\n  ../modules/nixos/core           # Always needed\n  ../modules/nixos/services/_categories/media    # Only if host uses media\n  ../modules/nixos/services/_categories/infra    # Only if host uses infra\n  # host-specific stuff\n];\n\\`\\`\\`\n\n## Key files\n- \\`lib/mkSystem.nix\\` - NixOS configuration builder\n- \\`modules/nixos/default.nix\\` - current monolithic import\n- \\`hosts/*/default.nix\\` - host configurations\n\n## Dependencies\n- Requires nix-config-ehw (categories must exist first)\n- Requires nix-config-1pr (circular deps block selective imports)\n\n## Implementation approach\n1. Add \\`moduleCategories\\` parameter to \\`mkSystem\\`\n2. Default to all categories (backward compatible)\n3. Allow hosts to override with specific list\n4. Test with forge first\n\n## Documentation updates (do alongside implementation)\n- [ ] Update \\`docs/repository-architecture.md\\` Import Flow section\n- [ ] Add lazy loading example to \\`docs/modular-design-patterns.md\\`\n- [ ] Update any docs referencing \\`modules/nixos/default.nix\\` monolithic import\n\n## Verification\n\\`\\`\\`bash\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel\n# Should show reduced eval time/derivations vs baseline\n\\`\\`\\`","acceptance_criteria":"- A host can build without importing the entire `modules/nixos/default.nix` surface\\n- `nix build .#ciSystems.forge` still works\\n- Evaluation stats improve or stay flat vs baseline","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-16T14:26:37.33809-05:00","updated_at":"2025-12-16T15:17:59.066785-05:00","dependencies":[{"issue_id":"nix-config-58b","depends_on_id":"nix-config-1pr","type":"blocks","created_at":"2025-12-16T14:41:12.123453-05:00","created_by":"daemon"},{"issue_id":"nix-config-58b","depends_on_id":"nix-config-ehw","type":"blocks","created_at":"2025-12-16T14:53:43.400022-05:00","created_by":"daemon"}]}
{"id":"nix-config-5i2","title":"Evaluate nixos-unified or flake-parts autowiring","description":"Research whether nixos-unified or flake-parts autowiring would help this repo.\n\n## Context\nThis repo uses flake-parts already. The question is whether adopting autowiring patterns (automatic module/package discovery) would:\n1. Reduce boilerplate\n2. Support lazy loading goals\n3. Not increase evaluation cost\n\n## Research tasks\n1. Review nixos-unified: https://github.com/srid/nixos-unified\n2. Review flake-parts autowiring patterns\n3. Compare to current \\`pkgs/default.nix\\` (17 packages, manual callPackage)\n4. Compare to current \\`modules/nixos/default.nix\\` (104 services, manual imports)\n\n## Key questions\n- Does autowiring support selective/lazy imports?\n- What's the eval-time cost of directory scanning?\n- Does it play well with the category-based imports from nix-config-ehw?\n\n## Current state (for comparison)\n\\`\\`\\`bash\n# Packages - manual\nls pkgs/  # ~17 packages\n\n# Modules - manual\nls modules/nixos/services/ | wc -l  # ~104 services\n\\`\\`\\`\n\n## Decision criteria\n- **Go**: Demonstrable boilerplate reduction + no eval regression\n- **No-go**: Eval cost increase OR conflicts with lazy loading goals\n\n## Output\nRecord decision in issue notes with rationale. If go, create follow-up implementation issue.","acceptance_criteria":"- Clear go/no-go decision recorded\\n- If go: a small pilot proves it reduces boilerplate without increasing eval cost\\n- If no-go: rationale documented","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-16T14:27:48.246715-05:00","updated_at":"2025-12-16T14:57:43.5975-05:00","dependencies":[{"issue_id":"nix-config-5i2","depends_on_id":"nix-config-58b","type":"blocks","created_at":"2025-12-16T14:41:12.205121-05:00","created_by":"daemon"}]}
{"id":"nix-config-8to","title":"Split lib/types.nix into smaller focused files","description":"Split lib/types.nix into smaller, focused files for maintainability.\n\n## Current state\n\\`lib/types.nix\\` contains ALL shared type definitions:\n\\`\\`\\`bash\nwc -l lib/types.nix  # Check line count\nhead -100 lib/types.nix  # See structure\n\\`\\`\\`\n\n## Proposed structure\n\\`\\`\\`\nlib/\n├── types/\n│   ├── default.nix       # Re-exports all types (backward compat)\n│   ├── reverse-proxy.nix # reverseProxySubmodule\n│   ├── metrics.nix       # metricsSubmodule  \n│   ├── logging.nix       # loggingSubmodule\n│   ├── backup.nix        # backupSubmodule\n│   ├── storage.nix       # datasetSubmodule, storageTypes\n│   ├── container.nix     # containerResourcesSubmodule\n│   └── healthcheck.nix   # healthcheckSubmodule\n└── types.nix             # Deprecated, imports from types/default.nix\n\\`\\`\\`\n\n## Implementation steps\n1. Create \\`lib/types/\\` directory\n2. Move each submodule type to its own file\n3. Create \\`lib/types/default.nix\\` that imports and re-exports all\n4. Update \\`lib/types.nix\\` to just import from \\`lib/types/default.nix\\`\n5. Verify no breakage\n\n## Key files\n- \\`lib/types.nix\\` - current monolithic file\n- \\`lib/default.nix\\` - exports mylib.types\n\n## Documentation updates (do alongside implementation)\n- [ ] Update \\`docs/modular-design-patterns.md\\` Shared Types Library section\n- [ ] Update \\`docs/repository-architecture.md\\` lib/ directory structure\n- [ ] Update import examples in prompts/agents if they reference \\`lib/types.nix\\` directly\n\n## Verification\n\\`\\`\\`bash\nnix flake check\nnix build .#nixosConfigurations.forge.config.system.build.toplevel\n# Grep for type usage to ensure nothing broke\nrg 'sharedTypes\\.' modules/\n\\`\\`\\`","acceptance_criteria":"- Types are split into coherent files (e.g., reverseProxy, metrics, logging, backup, storage)\\n- No call sites break\\n- `nix flake check` passes","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-16T14:27:14.707507-05:00","updated_at":"2025-12-16T15:18:11.580326-05:00"}
{"id":"nix-config-8v5","title":"Add nix garbage collection configuration","description":"Add Nix garbage collection configuration to prevent disk bloat while preserving rollback capability.\n\n## Current state\nCheck current GC config:\n\\`\\`\\`bash\n# On a NixOS host\ngrep -r 'gc' /etc/nixos/ || echo 'No GC config found'\nnix-store --gc --print-dead | wc -l  # How much garbage?\n\\`\\`\\`\n\n## Recommended configuration\nAdd to a shared module or host config:\n\\`\\`\\`nix\n# modules/nixos/common/nix.nix or similar\nnix.gc = {\n  automatic = true;\n  dates = \"weekly\";\n  options = \"--delete-older-than 30d\";\n};\n\n# Keep N generations for rollback\nnix.settings.keep-outputs = true;\nnix.settings.keep-derivations = true;\n\n# For NixOS specifically\nsystem.autoUpgrade.allowReboot = false;  # Don't auto-reboot\n\\`\\`\\`\n\n## For Darwin (rymac)\n\\`\\`\\`nix\n# modules/darwin/nix.nix or similar\nnix.gc = {\n  automatic = true;\n  interval = { Weekday = 0; Hour = 2; Minute = 0; };\n  options = \"--delete-older-than 30d\";\n};\n\\`\\`\\`\n\n## Key files to check/modify\n- \\`modules/nixos/common/nix.nix\\` - if exists\n- \\`modules/darwin/nix.nix\\` - for macOS\n- \\`profiles/\\` - might have nix settings\n\n## Verification\n\\`\\`\\`bash\n# After applying\nsystemctl list-timers | grep gc\nnix-store --gc --print-dead | head -20\n\\`\\`\\`\n\n## Documentation\nAdd to README or docs/ explaining:\n- GC schedule\n- How many generations kept\n- How to manually trigger GC\n- How to rollback if needed","acceptance_criteria":"- GC policy is defined (schedule + retention)\\n- Works for at least one NixOS host and Darwin if applicable\\n- Documented in README/docs","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-16T14:26:55.63519-05:00","updated_at":"2025-12-16T14:57:01.626849-05:00"}
{"id":"nix-config-dig","title":"Profile evaluation with NIX_SHOW_STATS","description":"Establish an evaluation-performance baseline before any import refactoring work begins.\n\n## Commands to run\n\\`\\`\\`bash\n# Primary benchmark - forge is the heaviest host\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel 2\u003e\u00261 | tee eval-baseline.txt\n\n# Quick check (no build, just eval)\ntime nix eval .#nixosConfigurations.forge.config.system.build.toplevel --raw 2\u003e/dev/null\n\\`\\`\\`\n\n## Key files\n- \\`modules/nixos/default.nix\\` - current monolithic import (104 service modules)\n- \\`lib/mkSystem.nix\\` - where modules get wired into hosts\n- \\`hosts/forge/default.nix\\` - heaviest host config\n\n## What to record\n- Total evaluation time\n- Number of derivations\n- Memory usage if available\n- Copy these stats into the issue notes field\n\n## Success criteria\nBaseline recorded. This issue is complete once we have numbers to compare against.","acceptance_criteria":"- Baseline eval stats recorded in the issue notes\\n- After refactors, rerun the same command(s) and record deltas\\n- Any major regressions are called out","notes":"## Baseline Results (2025-12-16)\n\n### Quick Eval Timing\n- **Wall time**: 41.43 seconds\n- **CPU time**: 17.30 seconds (user) + 2.16 seconds (sys)\n\n### NIX_SHOW_STATS Output\n| Metric | Value |\n|--------|-------|\n| CPU Time | 17.85s |\n| GC Time | 5.75s (32% of total) |\n| Heap Size | 1.85 GB |\n| Total GC Bytes | 2.80 GB |\n| Function Calls | 21.6M |\n| Thunks | 31.2M |\n| Values | 41.3M |\n| Sets | 6.1M (77.5M elements) |\n| Envs | 24.8M |\n| Expressions | 2.9M |\n\n### Module Counts\n- Service modules: 104\n- Total NixOS modules: 137\n- Forge service files: 60\n\n### Key Observations\n1. **GC pressure is high** - 32% of eval time in garbage collection\n2. **Set operations dominate** - 77M set elements, 54M values copied in updates\n3. **Many thunks** - 31M thunks suggests heavy lazy evaluation\n4. **Large heap** - 1.85GB heap for a single host config\n\n### Comparison Targets\nAfter refactoring (ehw, 58b, 1pr), re-run these commands:\n\\`\\`\\`bash\ntime nix eval .#nixosConfigurations.forge.config.system.build.toplevel --raw\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel --dry-run\n\\`\\`\\`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T14:27:05.645911-05:00","updated_at":"2025-12-16T15:24:45.825208-05:00","closed_at":"2025-12-16T15:24:45.825208-05:00"}
{"id":"nix-config-ehw","title":"Split service modules into category-based imports","description":"Split service modules into category-based imports so hosts can import only what they need.\n\n## Current structure\n\\`modules/nixos/default.nix\\` imports ALL 104 service modules unconditionally:\n\\`\\`\\`nix\nimports = [\n  ./services/sonarr\n  ./services/radarr\n  ./services/plex\n  # ../.. 101 more services\n];\n\\`\\`\\`\n\n## Proposed structure\nCreate category files in \\`modules/nixos/services/\\`:\n\\`\\`\\`\nmodules/nixos/services/\n├── _categories/\n│   ├── media.nix      # sonarr, radarr, plex, jellyfin, etc.\n│   ├── downloads.nix  # sabnzbd, qbittorrent, prowlarr\n│   ├── infra.nix      # caddy, postgresql, redis\n│   ├── observability.nix  # grafana, loki, prometheus\n│   ├── auth.nix       # pocketid, keycloak\n│   ├── storage.nix    # zfs, sanoid, nfs\n│   └── home.nix       # home-assistant, esphome, zigbee2mqtt\n├── default.nix        # imports all categories (backward compat)\n└── [individual services...]\n\\`\\`\\`\n\n## Implementation steps\n1. Identify which services belong to which category (review \\`hosts/forge/services/\\`)\n2. Create category import files\n3. Update \\`modules/nixos/default.nix\\` to import categories\n4. Test that \\`nix build .#nixosConfigurations.forge...\\` still works\n\n## Key files to modify\n- \\`modules/nixos/default.nix\\` - main entry point\n- \\`modules/nixos/services/default.nix\\` - service imports\n- Create new \\`modules/nixos/services/_categories/*.nix\\` files\n\n## Documentation updates (do alongside implementation)\n- [ ] Update \\`docs/repository-architecture.md\\` directory structure diagram\n- [ ] Update \\`.github/copilot-instructions.md\\` Repository Architecture section\n- [ ] Update \\`.github/prompts/nixos/service-module.prompt.md\\` Pattern Discovery Phase\n- [ ] Update \\`.github/agents/nixos-service-scaffold.agent.md\\` with category guidance\n- [ ] Update \\`.github/instructions/nixos-instructions.md\\` Module Development Workflow\n\n## Verification\n\\`\\`\\`bash\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel\n# Compare to baseline from nix-config-dig\n\\`\\`\\`","acceptance_criteria":"- Category import files exist and are used by at least one host\\n- No service behavior changes (pure refactor)\\n- Evaluation stats do not regress","notes":"Categories implemented. 13 category files created under modules/nixos/services/_categories/. Removed privatebin (empty dir). All configs pass nix flake check. Timing: 31.5s (baseline 41.4s - no regression).","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-16T14:26:46.466962-05:00","updated_at":"2025-12-16T15:33:38.171592-05:00","closed_at":"2025-12-16T15:33:38.171592-05:00","dependencies":[{"issue_id":"nix-config-ehw","depends_on_id":"nix-config-dig","type":"blocks","created_at":"2025-12-16T14:40:55.097348-05:00","created_by":"daemon"}]}
{"id":"nix-config-gzk","title":"Consider host-specific module imports","description":"Each host should explicitly declare which module categories it needs, rather than importing everything.\n\n## Current state\nHosts implicitly get all modules via \\`lib/mkSystem.nix\\`:\n\\`\\`\\`nix\n# hosts/forge/default.nix\n{ ../.. }: {\n  imports = [ ./services ./core ./infrastructure ];\n  # Gets ALL service modules even if only using 20\n}\n\\`\\`\\`\n\n## Proposed state\n\\`\\`\\`nix\n# hosts/forge/default.nix\n{ ../.. }: {\n  imports = [ ./services ./core ./infrastructure ];\n  \n  # Explicit category selection\n  modules.categories = [ \"media\" \"downloads\" \"infra\" \"observability\" \"home\" ];\n}\n\\`\\`\\`\n\nOr directly in mkSystem call:\n\\`\\`\\`nix\n# In flake.nix or lib/mkSystem.nix\nmkSystem {\n  host = \"forge\";\n  categories = [ \"media\" \"downloads\" \"infra\" \"observability\" \"home\" ];\n}\n\\`\\`\\`\n\n## Key files\n- \\`hosts/forge/default.nix\\` - pilot host\n- \\`hosts/luna/default.nix\\` - secondary test (simpler host)\n- \\`lib/mkSystem.nix\\` - needs to support category selection\n\n## Dependencies\n- Requires nix-config-ehw (categories defined)\n- Informed by nix-config-dig (baseline comparison)\n\n## Verification\n1. Pick a simple host (luna or nixpi)\n2. Define explicit category list\n3. Verify build succeeds\n4. Verify no orphaned contributions (alerts, datasets) when service disabled","acceptance_criteria":"- At least one host switches to host-specific imports\\n- Host still builds and deploys\\n- No orphaned infrastructure contributions when a service is disabled","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-16T14:27:39.032908-05:00","updated_at":"2025-12-16T14:56:49.129027-05:00","dependencies":[{"issue_id":"nix-config-gzk","depends_on_id":"nix-config-ehw","type":"blocks","created_at":"2025-12-16T14:28:02.466899-05:00","created_by":"daemon"},{"issue_id":"nix-config-gzk","depends_on_id":"nix-config-dig","type":"blocks","created_at":"2025-12-16T14:40:55.131661-05:00","created_by":"daemon"}]}
{"id":"nix-config-mla","title":"Add flake input version pinning documentation","description":"Document the flake input version pinning policy and update workflow.\n\n## What to document\n1. **Input sources** - which inputs use stable vs unstable nixpkgs\n2. **Update cadence** - how often inputs are updated\n3. **Renovate integration** - how Renovate PRs fit in\n4. **Rollback procedure** - how to revert a bad update\n\n## Key files to reference\n- \\`flake.nix\\` - input definitions\n- \\`flake.lock\\` - pinned versions\n- \\`.github/workflows/update-flake-lock.yml\\` - automation\n- \\`Taskfile.yaml\\` - manual commands\n\n## Taskfile commands to document\n\\`\\`\\`bash\ntask --list | grep -i flake  # Find relevant tasks\n# Likely includes:\n# task nix:update-flake\n# task nix:update-input INPUT=nixpkgs\n\\`\\`\\`\n\n## Suggested doc location\n\\`docs/flake-management.md\\` or add section to \\`README.md\\`\n\n## Content outline\n\\`\\`\\`markdown\n# Flake Input Management\n\n## Inputs Overview\n| Input | Channel | Purpose |\n|-------|---------|---------|\n| nixpkgs | nixos-25.11 | Stable packages |\n| nixpkgs-unstable | nixos-unstable | Bleeding edge |\n| home-manager | release-25.11 | User environment |\n| ../.. | ../.. | ../.. |\n\n## Update Workflow\n1. Renovate creates PRs for container updates\n2. \\`task nix:update-flake\\` updates all inputs\n3. CI builds and tests\n\n## Manual Update\n\\`\\`\\`bash\ntask nix:update-flake\n# or specific input\nnix flake lock --update-input nixpkgs\n\\`\\`\\`\n\n## Rollback\n\\`\\`\\`bash\ngit checkout HEAD~1 -- flake.lock\nnix flake lock --no-update-lock-file\n\\`\\`\\`\n\\`\\`\\`\n\n## Note\nThis issue can be done independently of the architectural refactors (ehw, 58b, 8to, 1pr). However, if the lazy loading work changes how inputs are consumed, this doc may need updates.","acceptance_criteria":"- Docs describe update workflow and pinning rationale\\n- References Taskfile commands used in this repo","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-16T14:27:31.824177-05:00","updated_at":"2025-12-16T15:18:55.926234-05:00"}

{"id":"nix-config-0e9","title":"Audit miniflux/grafana pocketIdEnabled pattern for consistency","description":"Both miniflux and grafana modules reference pocketid for OIDC provider display naming:\n\n**miniflux/default.nix line 38**:\n\\`\\`\\`nix\npocketIdEnabled = config.modules.services.pocketid.enable or false;\noidcProviderName = if pocketIdEnabled then \"Pocket ID\" else \"SSO\";\n\\`\\`\\`\n\n**grafana/default.nix line 54**:\n\\`\\`\\`nix\npocketIdEnabled = config.modules.services.pocketid.enable or false;\noidcProviderName = if pocketIdEnabled then \"Pocket ID\" else \"OIDC\";\n\\`\\`\\`\n\n**Analysis**: LOW-RISK - only affects display strings, not functionality\n\n**Minor Inconsistency**: Different fallback names (\"SSO\" vs \"OIDC\")\n\n**Decision**: ACCEPT inconsistency - not worth the complexity to centralize\n\n**Rationale**:\n1. Uses \\`or false\\` for safe evaluation ✓\n2. No functional dependency created ✓\n3. Display strings are context-appropriate (Grafana calls it 'OIDC', Miniflux calls it 'SSO')\n4. Centralizing would add abstraction for minimal benefit\n\n**Deliverable**: Close this issue - no code changes required. The inconsistency is acceptable and arguably intentional (context-appropriate naming).\n\n**Files reviewed**:\n- modules/nixos/services/miniflux/default.nix (line 38)\n- modules/nixos/services/grafana/default.nix (line 54)","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-19T08:27:23.295684-05:00","updated_at":"2025-12-19T08:47:29.856049-05:00","closed_at":"2025-12-19T08:47:29.856049-05:00","dependencies":[{"issue_id":"nix-config-0e9","depends_on_id":"nix-config-hc6","type":"parent-child","created_at":"2025-12-19T08:27:59.451946-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-0oe","title":"Consider lazy trees for faster flake source copying","description":"**Problem**: Nix copies the entire git working tree into the store on every flake operation. For a 122MB repository, this adds overhead.\n\n**Current Behavior**:\n- Every \\`nix build\\`, \\`nix eval\\`, etc. copies source to /nix/store\n- Dirty trees re-copy on every change\n- Large files (even gitignored) can impact copy time\n\n**Potential Solutions**:\n\n1. **Lazy Trees (Experimental)** - Nix PR #6530:\n\\`\\`\\`nix\n# nix.conf\nexperimental-features = nix-command flakes lazy-trees\n\\`\\`\\`\nNote: Still experimental, may have bugs.\n\n2. **Optimize .gitignore**:\nEnsure all build artifacts, caches, and large files are gitignored:\n\\`\\`\\`\nresult\n.direnv/\ntmp/\nsite/\n*.sqlite\n\\`\\`\\`\n\n3. **Use git worktrees for clean builds**:\n\\`\\`\\`bash\n# CI pattern - clean tree = no copy overhead\ngit worktree add /tmp/nix-build\n\\`\\`\\`\n\n**Current Repo Size**: 122MB\n\n**Files to check**:\n- \\`.gitignore\\` - ensure comprehensive\n- \\`.git/info/exclude\\` - local excludes\n- Large directories: result/, site/, tmp/, .direnv/\n\n**Verification**:\n\\`\\`\\`bash\n# Find large untracked files\ngit ls-files --others --exclude-standard | xargs du -sh | sort -h | tail -20\n\\`\\`\\`","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-16T19:51:16.837179-05:00","updated_at":"2025-12-16T20:33:10.902493-05:00","closed_at":"2025-12-16T20:33:10.902493-05:00"}
{"id":"nix-config-1jf","title":"Deduplicate flake inputs with follows directives","description":"**Problem**: flake.lock has 34 nodes with duplicate transitive inputs.\n\n**COMPLETED** ✅\n\n**Results**:\n- **Before**: 30 non-root nodes\n- **After**: 27 non-root nodes\n- **Reduction**: 3 nodes eliminated (10%)\n\n**Changes Made to \\`flake.nix\\`**:\nAdded follows directives to \\`nix-inspect\\` input:\n\\`\\`\\`nix\ninputs.parts.follows = \"flake-parts\";\ninputs.nci.inputs.nixpkgs.follows = \"nixpkgs\";\ninputs.nci.inputs.parts.follows = \"flake-parts\";\ninputs.nci.inputs.rust-overlay.follows = \"rust-overlay\";\ninputs.nci.inputs.treefmt.inputs.nixpkgs.follows = \"nixpkgs\";\ninputs.nci.inputs.dream2nix.inputs.nixpkgs.follows = \"nixpkgs\";\n\\`\\`\\`\n\n**Duplicates Eliminated**:\n| Original | Duplicate | Resolution |\n|----------|-----------|------------|\n| \\`flake-parts\\` | \\`parts\\`, \\`parts_2\\` | Both now follow \\`flake-parts\\` |\n| \\`rust-overlay\\` | \\`rust-overlay_2\\` | Now follows \\`rust-overlay\\` |\n\n**Could Not Deduplicate** (already optimized or no inputs):\n- \\`purescript-overlay\\`, \\`slimlock\\`, \\`flake-compat\\`, \\`pyproject-nix\\` - leaf deps with no/null inputs\n- \\`crane\\`, \\`mk-naked-shell\\` - pure flakes with no inputs\n- \\`catppuccin\\` - no inputs\n- Existing follows for \\`home-manager\\`, \\`disko\\`, \\`sops-nix\\`, \\`nixvim\\`, etc. were already well-optimized\n\n**Files Modified**:\n- \\`flake.nix\\`\n- \\`flake.lock\\` (regenerated)\n\n**Verification**: \\`nix eval .#nixosConfigurations.forge.config.system.build.toplevel.name\\` ✅","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-16T19:50:45.63951-05:00","updated_at":"2025-12-16T20:16:20.325729-05:00","closed_at":"2025-12-16T20:15:15.419728-05:00"}
{"id":"nix-config-1pr","title":"Refactor storage-helpers circular dependency pattern","description":"Refactor the storage-helpers circular dependency workarounds found throughout the codebase (~20+ instances).\n\n## The problem\nServices use a workaround pattern to avoid circular dependencies when accessing \\`mylib.storageHelpers\\`:\n\\`\\`\\`nix\n# Passed in to avoid circular dependencies in module evaluation\nmkStorageDependencies = config.mylib.storageHelpers.mkStorageDependencies;\n\\`\\`\\`\n\n## Affected files (grep for 'circular' or 'mkStorageDependencies')\n- \\`modules/nixos/services/sonarr/default.nix\\`\n- \\`modules/nixos/services/radarr/default.nix\\`\n- \\`modules/nixos/services/prowlarr/default.nix\\`\n- \\`modules/nixos/services/sabnzbd/default.nix\\`\n- \\`modules/nixos/services/lidarr/default.nix\\`\n- \\`modules/nixos/services/readarr/default.nix\\`\n- \\`modules/nixos/services/bazarr/default.nix\\`\n- \\`modules/nixos/services/qbittorrent/default.nix\\`\n- \\`modules/nixos/services/postgresql/storage-integration.nix\\`\n- \\`modules/nixos/services/postgresql/databases.nix\\`\n- \\`modules/nixos/services/github-runner/default.nix\\`\n- \\`hosts/forge/services/monitoring-hub.nix\\`\n- And others - run: \\`rg -l 'circular|mkStorageDependencies' modules/\\`\n\n## Root cause\n\\`lib/default.nix\\` exposes \\`mylib\\` which includes \\`storageHelpers\\`. When modules try to access \\`config.mylib.storageHelpers\\` during option definition (not config evaluation), it creates a cycle.\n\n## Potential solutions\n1. Move storageHelpers to a separate module that's imported earlier\n2. Use \\`lib.mkDefault\\` or \\`lib.mkOverride\\` patterns\n3. Restructure so helpers don't depend on config\n4. Related to lazy loading - if modules are loaded lazily, the cycle may resolve naturally\n\n## Documentation updates (do alongside implementation)\n- [ ] Document the resolved pattern in \\`docs/modular-design-patterns.md\\`\n- [ ] Remove/update any docs that reference the workaround pattern\n- [ ] Add ADR if the solution involves architectural changes\n\n## Verification\n\\`\\`\\`bash\nnix flake check\nnix build .#nixosConfigurations.forge.config.system.build.toplevel\n\\`\\`\\`","acceptance_criteria":"- Remove the PostgreSQL circular-dep FIXME and eliminate the recursion/cycle\\n- `nix flake check` succeeds\\n- `nix build .#ciSystems.forge` succeeds\\n- Postgres-dependent integrations (alerts/datasources/backups) still evaluate","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-16T14:40:04.239419-05:00","updated_at":"2025-12-16T17:21:28.584012-05:00","closed_at":"2025-12-16T17:21:28.584012-05:00"}
{"id":"nix-config-2m7","title":"Audit and optimize overlay evaluation","description":"**Problem**: Overlay evaluation may be inefficient.\n\n**CLOSED - No Changes Needed** ✅\n\n**Audit Results**:\n\n| Overlay | Purpose | Used? |\n|---------|---------|-------|\n| rust-overlay | Rust toolchain | ✅ Yes - nix-inspect, custom pkgs |\n| additions | Custom packages | ✅ Yes - core functionality |\n| unstable-packages | pkgs.unstable | ✅ Yes - 12+ packages |\n| nixpkgs-overlays | Custom Caddy | ✅ Yes - all Caddy services |\n\n**Packages using pkgs.unstable** (12+):\n- beszel, n8n, open-webui, pocket-id, zigbee2mqtt\n- helm-ls, minio-client, starship, k9s, kubecm, helmfile, lima, vscode\n- Custom Caddy build\n\n**Conclusion**: \n- All overlays are actively used\n- Nix is lazy - overlays are thunks, imports only happen when accessed\n- No dead code to remove\n- Overlay structure is already optimal","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T19:51:28.142683-05:00","updated_at":"2025-12-16T20:28:59.303065-05:00","closed_at":"2025-12-16T20:28:59.303073-05:00"}
{"id":"nix-config-4s6","title":"Fix termix module infinite recursion (config reference in let block)","description":"The termix module at modules/nixos/services/termix/default.nix has an infinite recursion due to referencing config.modules.storage.datasets.parentDataset in the let block (line 33). This is evaluated during module loading before options are defined, causing the error:\n\n```\nerror: infinite recursion encountered\n... while evaluating the module argument 'config' in 'termix'\n```\n\n**Fix**: Move the `datasetPath` computation inside `config = mkIf cfg.enable { ... }` where config references are safe. Example:\n```nix\n# Change from:\nlet datasetPath = \"${storageCfg.datasets.parentDataset}/termix\"; in\n\n# To: Inside config block\nconfig = mkIf cfg.enable {\n  # Define locally where safe to reference config\n  let datasetPath = \"${config.modules.storage.datasets.parentDataset}/termix\";\n};\n```\n\nSee ADR-010 (Cross-Module Dependency Patterns) for guidance on safe config references.","status":"tombstone","priority":2,"issue_type":"bug","created_at":"2026-01-02T12:23:52.949065-05:00","updated_at":"2026-01-02T13:25:14.568824-05:00","deleted_at":"2026-01-02T13:25:14.568824-05:00","deleted_by":"git-history-backfill","delete_reason":"recovered from git history (pruned from manifest)","original_type":"bug"}
{"id":"nix-config-4wb","title":"Validate observability module follows thin orchestrator pattern","description":"The observability module at modules/nixos/services/observability/default.nix references other modules:\n\n\\`\\`\\`nix\n# Line 181: Wire Promtail to Loki\nmodules.services.promtail.lokiUrl = mkIf (cfg.promtail.enable \u0026\u0026 cfg.loki.enable)\n  \"http://127.0.0.1:\\{toString config.modules.services.loki.port}\";\n\n# Lines 183-186: Auto-configure Grafana datasources\nmodules.services.grafana.autoConfigure = mkIf cfg.grafana.enable {\n  loki = lib.mkDefault cfg.loki.enable;\n  prometheus = lib.mkDefault cfg.prometheus.enable;\n};\n\\`\\`\\`\n\n**Analysis**: This is the CORRECT thin orchestrator pattern because:\n1. Only ~200 lines - minimal coordination logic\n2. Does NOT re-expose individual service options\n3. Only wires cross-cutting concerns (Promtail→Loki URL, datasource registration)\n4. Uses mkDefault allowing host-level overrides\n5. Component toggles reference orchestrator's own enable flags\n\n**Decision**: EXEMPLARY - Document this as the reference implementation for thin orchestrators.\n\n**Note**: References to config.modules.services.loki.port are valid because the orchestrator controls whether loki is enabled.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-19T08:27:33.880825-05:00","updated_at":"2025-12-19T08:47:29.149784-05:00","closed_at":"2025-12-19T08:47:29.149784-05:00","dependencies":[{"issue_id":"nix-config-4wb","depends_on_id":"nix-config-hc6","type":"parent-child","created_at":"2025-12-19T08:27:59.502551-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-58b","title":"Implement lazy module loading for service modules","description":"Implement lazy module loading so hosts only import the module sets they actually need.\n\n## Goal\nInstead of every host importing all 104 service modules, each host imports only the categories it uses.\n\n## Current architecture\n\\`lib/mkSystem.nix\\` creates NixOS configurations:\n\\`\\`\\`nix\n# Every host gets ALL modules\nmodules = [\n  ../modules/nixos  # This pulls in everything\n  # host-specific stuff\n];\n\\`\\`\\`\n\n## Proposed architecture\n\\`\\`\\`nix\n# In lib/mkSystem.nix or host config\nmodules = [\n  ../modules/nixos/core           # Always needed\n  ../modules/nixos/services/_categories/media    # Only if host uses media\n  ../modules/nixos/services/_categories/infra    # Only if host uses infra\n  # host-specific stuff\n];\n\\`\\`\\`\n\n## Key files\n- \\`lib/mkSystem.nix\\` - NixOS configuration builder\n- \\`modules/nixos/default.nix\\` - current monolithic import\n- \\`hosts/*/default.nix\\` - host configurations\n\n## Dependencies\n- Requires nix-config-ehw (categories must exist first)\n- Requires nix-config-1pr (circular deps block selective imports)\n\n## Implementation approach\n1. Add \\`moduleCategories\\` parameter to \\`mkSystem\\`\n2. Default to all categories (backward compatible)\n3. Allow hosts to override with specific list\n4. Test with forge first\n\n## Documentation updates (do alongside implementation)\n- [ ] Update \\`docs/repository-architecture.md\\` Import Flow section\n- [ ] Add lazy loading example to \\`docs/modular-design-patterns.md\\`\n- [ ] Update any docs referencing \\`modules/nixos/default.nix\\` monolithic import\n\n## Verification\n\\`\\`\\`bash\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel\n# Should show reduced eval time/derivations vs baseline\n\\`\\`\\`","acceptance_criteria":"- A host can build without importing the entire `modules/nixos/default.nix` surface\\n- `nix build .#ciSystems.forge` still works\\n- Evaluation stats improve or stay flat vs baseline","notes":"All deployed hosts now use selective category loading. Performance results: rydev 11.60s (66% faster), luna 13.65s (60% faster), nixpi 18s (51% faster) vs forge baseline 33.89s. nas-0/nas-1 not yet deployed so left with default all-categories loading.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-16T14:26:37.33809-05:00","updated_at":"2025-12-16T16:49:26.417046-05:00","closed_at":"2025-12-16T16:49:26.417059-05:00","dependencies":[{"issue_id":"nix-config-58b","depends_on_id":"nix-config-1pr","type":"blocks","created_at":"2025-12-16T14:41:12.123453-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"nix-config-58b","depends_on_id":"nix-config-ehw","type":"blocks","created_at":"2025-12-16T14:53:43.400022-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-5dh","title":"Review teslamate grafanaIntegration hard dependency on Grafana module","description":"In modules/nixos/services/teslamate/default.nix line 502, there's an assertion that creates a hard dependency on the Grafana module:\n\n\\`\\`\\`nix\n{\n  assertion = (cfg.grafanaIntegration.enable \u0026\u0026 (config.modules.services.grafana.enable or false));\n  message = \"TeslaMate grafanaIntegration requires modules.services.grafana.enable.\";\n}\n\\`\\`\\`\n\n**Analysis**: This is a VALID cross-module reference because:\n1. It's wrapped with \\`or false\\` for safe evaluation\n2. TeslaMate's Grafana integration genuinely requires Grafana\n3. This is an opt-in feature (grafanaIntegration.enable)\n4. The assertion provides clear feedback when misconfigured\n\n**Decision**: KEEP - This follows the contributory pattern correctly. The module doesn't automatically configure Grafana; it validates that the user has enabled both if they want integration.\n\n**Documentation**: Consider documenting this pattern as an example of valid cross-module validation.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-19T08:26:42.655042-05:00","updated_at":"2025-12-19T08:47:29.696026-05:00","closed_at":"2025-12-19T08:47:29.696026-05:00","dependencies":[{"issue_id":"nix-config-5dh","depends_on_id":"nix-config-hc6","type":"parent-child","created_at":"2025-12-19T08:27:59.268378-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-5i2","title":"Evaluate nixos-unified or flake-parts autowiring","description":"Research whether nixos-unified or flake-parts autowiring would help this repo.\n\n## Context\nThis repo uses flake-parts already. The question is whether adopting autowiring patterns (automatic module/package discovery) would:\n1. Reduce boilerplate\n2. Support lazy loading goals\n3. Not increase evaluation cost\n\n## Research tasks\n1. Review nixos-unified: https://github.com/srid/nixos-unified\n2. Review flake-parts autowiring patterns\n3. Compare to current \\`pkgs/default.nix\\` (17 packages, manual callPackage)\n4. Compare to current \\`modules/nixos/default.nix\\` (104 services, manual imports)\n\n## Key questions\n- Does autowiring support selective/lazy imports?\n- What's the eval-time cost of directory scanning?\n- Does it play well with the category-based imports from nix-config-ehw?\n\n## Current state (for comparison)\n\\`\\`\\`bash\n# Packages - manual\nls pkgs/  # ~17 packages\n\n# Modules - manual\nls modules/nixos/services/ | wc -l  # ~104 services\n\\`\\`\\`\n\n## Decision criteria\n- **Go**: Demonstrable boilerplate reduction + no eval regression\n- **No-go**: Eval cost increase OR conflicts with lazy loading goals\n\n## Output\nRecord decision in issue notes with rationale. If go, create follow-up implementation issue.","acceptance_criteria":"- Clear go/no-go decision recorded\\n- If go: a small pilot proves it reduces boilerplate without increasing eval cost\\n- If no-go: rationale documented","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-16T14:27:48.246715-05:00","updated_at":"2025-12-16T19:43:56.113589-05:00","closed_at":"2025-12-16T19:43:56.113589-05:00","dependencies":[{"issue_id":"nix-config-5i2","depends_on_id":"nix-config-58b","type":"blocks","created_at":"2025-12-16T14:41:12.205121-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-67j","title":"Evaluate qbit-manage tqm/qbittorrent cross-service coordination","description":"In modules/nixos/services/qbit-manage/default.nix lines 327-368, there are multiple cross-service references to tqm and qbittorrent:\n\n\\`\\`\\`nix\n# Line 327: Start after qbittorrent if enabled\n++ lib.optional (config.modules.services.qbittorrent.enable or false) qbittorrentServiceUnit;\n\n# Lines 332-333: Restart tqm on failure\nonFailure = lib.optionals (config.modules.services.tqm.enable or false) [ \"tqm.service\" ]\n\n# Lines 366-368: Mutual exclusion with tqm\nExecStartPre = lib.mkIf (config.modules.services.tqm.enable or false) \"+systemctl stop tqm.service\";\nExecStartPost = lib.mkIf (config.modules.services.tqm.enable or false) \"+systemctl start tqm.service\";\n\\`\\`\\`\n\n**Analysis**: These are VALID because:\n1. All references use \\`or false\\` for safe evaluation\n2. The services genuinely need coordination (both manage the same qBittorrent instance)\n3. Without coordination, race conditions would cause data corruption\n\n**Decision**: KEEP current implementation - LOW PRIORITY for refactoring\n\n**Future Improvement** (not required now):\nConsider extracting coordination to a thin orchestrator module if more services need similar mutual-exclusion patterns. But the current implementation:\n- Works correctly\n- Is well-documented in code\n- Uses safe evaluation patterns\n\n**Deliverable**: Close this issue with decision documented. No code changes required unless user requests the orchestrator refactoring.\n\n**Files reviewed**:\n- modules/nixos/services/qbit-manage/default.nix (lines 327-368)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-19T08:27:03.480884-05:00","updated_at":"2025-12-19T08:47:29.280763-05:00","closed_at":"2025-12-19T08:47:29.280763-05:00","dependencies":[{"issue_id":"nix-config-67j","depends_on_id":"nix-config-hc6","type":"parent-child","created_at":"2025-12-19T08:27:59.359917-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-6m8","title":"Enable nix-eval-jobs or nix-fast-build for CI","description":"**Problem**: nix build/eval runs sequentially, not leveraging parallelism.\n\n**COMPLETED** ✅\n\n**Changes Made**:\n\n1. **Added to devShell** (\\`flake.nix\\`):\n\\`\\`\\`nix\nnix-fast-build # Parallel evaluation and builds for CI\n\\`\\`\\`\n\n2. **Added Taskfile tasks** (\\`.taskfiles/nix/Taskfile.yaml\\`):\n\\`\\`\\`yaml\nnix:fast-build:\n  desc: Build all CI targets in parallel\n  # Supports eval-only=true, skip-cached=true\n\nnix:fast-eval:\n  desc: Evaluate all NixOS/Darwin configs in parallel\n\\`\\`\\`\n\n**Verification**:\n- ✅ DevShell includes nix-fast-build-1.3.0\n- ✅ Tasks appear in \\`task --list\\`\n- ✅ Full forge eval passes\n\n**Usage**:\n\\`\\`\\`bash\ntask nix:fast-build              # Build all\ntask nix:fast-build eval-only=true  # Eval only\ntask nix:fast-eval               # Quick eval check\n\\`\\`\\`","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-16T19:51:38.205717-05:00","updated_at":"2025-12-16T20:29:14.862751-05:00","closed_at":"2025-12-16T20:29:14.86276-05:00"}
{"id":"nix-config-6qk","title":"Review dispatcharr PostgreSQL dependency assertion","description":"In modules/nixos/services/dispatcharr/default.nix line 414, there's an assertion requiring PostgreSQL:\n\n\\`\\`\\`nix\n{\n  assertion = config.modules.services.postgresql.enable or false;\n  message = \"Dispatcharr requires PostgreSQL to be enabled (modules.services.postgresql.enable).\";\n}\n\\`\\`\\`\n\n**Analysis**: This is a VALID cross-module reference because:\n1. Dispatcharr genuinely requires PostgreSQL as its database backend\n2. It's an unconditional requirement (not an optional integration)\n3. Uses \\`or false\\` for safe evaluation without infinite recursion\n4. Provides clear user feedback\n\n**Decision**: KEEP - This is an acceptable pattern for required dependencies. Unlike optional integrations, Dispatcharr cannot function without PostgreSQL.\n\n**Alternative Considered**: Could use a database abstraction layer, but that adds complexity for a single-database-backend service.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-19T08:26:50.559614-05:00","updated_at":"2025-12-19T08:47:29.450097-05:00","closed_at":"2025-12-19T08:47:29.450097-05:00","dependencies":[{"issue_id":"nix-config-6qk","depends_on_id":"nix-config-hc6","type":"parent-child","created_at":"2025-12-19T08:27:59.313144-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-7s4","title":"Refactor cross-seed backup default to remove lib.mkIf in option default","description":"In modules/nixos/services/cross-seed/default.nix lines 276-285, the backup option uses lib.mkIf cfg.enable inside the default value:\n\n\\`\\`\\`nix\ndefault = lib.mkIf cfg.enable {\n  enable = lib.mkDefault true;\n  ../..\n};\n\\`\\`\\`\n\n**Problem**: Using lib.mkIf inside a default is atypical and may cause evaluation issues. Other modules (like sonarr, autobrr) don't follow this pattern - they set default = null or a static default and handle conditionals in the config section.\n\n**Fix Required**:\n1. Change the default to \\`null\\`\n2. Move the conditional logic to the config section where \\`lib.mkIf cfg.enable\\` is properly evaluated\n\n**Reference Implementation** (see sonarr for pattern):\n\\`\\`\\`nix\n# In options section:\nbackup = lib.mkOption {\n  type = lib.types.nullOr sharedTypes.backupSubmodule;\n  default = null;\n  description = \"Backup configuration\";\n};\n\n# In config section:\nconfig = lib.mkIf cfg.enable {\n  # backup is configured via host config, not module default\n};\n\\`\\`\\`\n\n**Files to modify**: \n- modules/nixos/services/cross-seed/default.nix (lines 276-285)\n\n**Testing**: Run \\`nix flake check\\` after changes","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-12-19T08:26:32.863196-05:00","updated_at":"2025-12-19T08:47:15.169524-05:00","closed_at":"2025-12-19T08:47:15.169524-05:00","dependencies":[{"issue_id":"nix-config-7s4","depends_on_id":"nix-config-hc6","type":"parent-child","created_at":"2025-12-19T08:27:59.222051-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-8to","title":"Split lib/types.nix into smaller focused files","description":"Split lib/types.nix into smaller, focused files for maintainability.\n\n## Current state\n\\`lib/types.nix\\` contains ALL shared type definitions:\n\\`\\`\\`bash\nwc -l lib/types.nix  # Check line count\nhead -100 lib/types.nix  # See structure\n\\`\\`\\`\n\n## Proposed structure\n\\`\\`\\`\nlib/\n├── types/\n│   ├── default.nix       # Re-exports all types (backward compat)\n│   ├── reverse-proxy.nix # reverseProxySubmodule\n│   ├── metrics.nix       # metricsSubmodule  \n│   ├── logging.nix       # loggingSubmodule\n│   ├── backup.nix        # backupSubmodule\n│   ├── storage.nix       # datasetSubmodule, storageTypes\n│   ├── container.nix     # containerResourcesSubmodule\n│   └── healthcheck.nix   # healthcheckSubmodule\n└── types.nix             # Deprecated, imports from types/default.nix\n\\`\\`\\`\n\n## Implementation steps\n1. Create \\`lib/types/\\` directory\n2. Move each submodule type to its own file\n3. Create \\`lib/types/default.nix\\` that imports and re-exports all\n4. Update \\`lib/types.nix\\` to just import from \\`lib/types/default.nix\\`\n5. Verify no breakage\n\n## Key files\n- \\`lib/types.nix\\` - current monolithic file\n- \\`lib/default.nix\\` - exports mylib.types\n\n## Documentation updates (do alongside implementation)\n- [ ] Update \\`docs/modular-design-patterns.md\\` Shared Types Library section\n- [ ] Update \\`docs/repository-architecture.md\\` lib/ directory structure\n- [ ] Update import examples in prompts/agents if they reference \\`lib/types.nix\\` directly\n\n## Verification\n\\`\\`\\`bash\nnix flake check\nnix build .#nixosConfigurations.forge.config.system.build.toplevel\n# Grep for type usage to ensure nothing broke\nrg 'sharedTypes\\.' modules/\n\\`\\`\\`","acceptance_criteria":"- Types are split into coherent files (e.g., reverseProxy, metrics, logging, backup, storage)\\n- No call sites break\\n- `nix flake check` passes","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-16T14:27:14.707507-05:00","updated_at":"2025-12-16T19:34:46.255521-05:00","closed_at":"2025-12-16T19:34:46.255521-05:00"}
{"id":"nix-config-8v5","title":"Add nix garbage collection configuration","description":"Add Nix garbage collection configuration to prevent disk bloat while preserving rollback capability.\n\n## Current state\nCheck current GC config:\n\\`\\`\\`bash\n# On a NixOS host\ngrep -r 'gc' /etc/nixos/ || echo 'No GC config found'\nnix-store --gc --print-dead | wc -l  # How much garbage?\n\\`\\`\\`\n\n## Recommended configuration\nAdd to a shared module or host config:\n\\`\\`\\`nix\n# modules/nixos/common/nix.nix or similar\nnix.gc = {\n  automatic = true;\n  dates = \"weekly\";\n  options = \"--delete-older-than 30d\";\n};\n\n# Keep N generations for rollback\nnix.settings.keep-outputs = true;\nnix.settings.keep-derivations = true;\n\n# For NixOS specifically\nsystem.autoUpgrade.allowReboot = false;  # Don't auto-reboot\n\\`\\`\\`\n\n## For Darwin (rymac)\n\\`\\`\\`nix\n# modules/darwin/nix.nix or similar\nnix.gc = {\n  automatic = true;\n  interval = { Weekday = 0; Hour = 2; Minute = 0; };\n  options = \"--delete-older-than 30d\";\n};\n\\`\\`\\`\n\n## Key files to check/modify\n- \\`modules/nixos/common/nix.nix\\` - if exists\n- \\`modules/darwin/nix.nix\\` - for macOS\n- \\`profiles/\\` - might have nix settings\n\n## Verification\n\\`\\`\\`bash\n# After applying\nsystemctl list-timers | grep gc\nnix-store --gc --print-dead | head -20\n\\`\\`\\`\n\n## Documentation\nAdd to README or docs/ explaining:\n- GC schedule\n- How many generations kept\n- How to manually trigger GC\n- How to rollback if needed","acceptance_criteria":"- GC policy is defined (schedule + retention)\\n- Works for at least one NixOS host and Darwin if applicable\\n- Documented in README/docs","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-16T14:26:55.63519-05:00","updated_at":"2025-12-16T17:17:03.060831-05:00","closed_at":"2025-12-16T17:17:03.060831-05:00"}
{"id":"nix-config-as6","title":"Pin nixpkgs to specific channel for faster registry lookups","description":"**Problem**: CLI commands like \\`nix shell nixpkgs#\u003cpkg\u003e\\` download fresh nixpkgs tarball.\n\n**COMPLETED** ✅\n\n**Changes Made to \\`modules/common/nix.nix\\`**:\n\\`\\`\\`nix\n# Pin nixpkgs registry to flake input\nregistry.nixpkgs.flake = inputs.nixpkgs;\n\\`\\`\\`\n\n**Already Present** (no changes needed):\n\\`\\`\\`nix\nnixPath = [ \"nixpkgs=\\{inputs.nixpkgs.outPath}\" ];\n\\`\\`\\`\n\n**How inputs available**: Via \\`_module.args = { inherit inputs system; }\\` in mkSystem.nix\n\n**Verification**:\n- ✅ NixOS registry eval passes\n- ✅ Darwin registry eval passes  \n- ✅ Full forge eval passes\n\n**Benefits**:\n- \\`nix shell nixpkgs#hello\\` now instant (no download)\n- Consistent nixpkgs version across all nix commands\n- Legacy \\`nix-shell\\` also uses pinned version","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-16T19:50:55.857022-05:00","updated_at":"2025-12-16T20:29:06.665417-05:00","closed_at":"2025-12-16T20:29:06.665421-05:00"}
{"id":"nix-config-cs6","title":"Add Gatus contribution for cross-seed service","description":"Cross-seed lacks black-box monitoring via Gatus. Per monitoring-strategy.md, user-facing services with web interfaces should have a Gatus health check.\n\n**Location**: Add to hosts/forge/services/cross-seed.nix inside the serviceEnabled guard block\n\n**Rationale**: Following contributory patterns, the Gatus contribution must be in the host config (not the module) to avoid creating a dependency on Gatus.\n\n**Implementation**:\n\\`\\`\\`nix\nmodules.services.gatus.contributions.cross-seed = {\n  name = \"Cross-Seed\";\n  group = \"Media\";\n  url = \"http://127.0.0.1:2468/api/ping\";\n  interval = \"60s\";\n  conditions = [ \"[STATUS] == 200\" ];\n};\n\\`\\`\\`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T08:26:22.459485-05:00","updated_at":"2025-12-19T08:47:15.325628-05:00","closed_at":"2025-12-19T08:47:15.325628-05:00","dependencies":[{"issue_id":"nix-config-cs6","depends_on_id":"nix-config-hc6","type":"parent-child","created_at":"2025-12-19T08:27:52.656513-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-d8o","title":"Review postgresql Grafana integration pattern","description":"In modules/nixos/services/postgresql/default.nix line 1258, PostgreSQL conditionally configures Grafana:\n\n\\`\\`\\`nix\n(lib.mkIf (cfg.enable \u0026\u0026 (config.modules.services.grafana.enable or false) \u0026\u0026 postgresGrafanaIntegrations = []) {\n  # Grafana datasource provisioning\n})\n\\`\\`\\`\n\n**Analysis**: BORDERLINE pattern - works but could be cleaner\n\n**Current Behavior**:\n- PostgreSQL module 'reaches into' Grafana's config to add datasources\n- Triple-guard makes it safe (only runs when both services enabled AND integrations exist)\n- Enables zero-config: databases automatically appear in Grafana\n\n**Concern**: If Grafana module changes its integrations interface, PostgreSQL breaks\n\n**Decision**: KEEP for now - the convenience outweighs the coupling risk in a homelab context\n\n**Rationale**:\n1. The coupling is well-guarded with \\`or false\\`\n2. Breaking changes would be caught by \\`nix flake check\\`\n3. Refactoring to inverse contribution would add complexity for minimal benefit\n4. This pattern is already documented in modular-design-patterns.md under 'Cross-Service Contribution Interfaces'\n\n**Deliverable**: Close with decision documented. Consider refactoring only if Grafana integration becomes unstable or more databases need similar patterns.\n\n**Files reviewed**:\n- modules/nixos/services/postgresql/default.nix (line 1258)\n- docs/modular-design-patterns.md (Cross-Service Contribution Interfaces section)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-19T08:27:44.313591-05:00","updated_at":"2025-12-19T08:47:28.993045-05:00","closed_at":"2025-12-19T08:47:28.993045-05:00","dependencies":[{"issue_id":"nix-config-d8o","depends_on_id":"nix-config-hc6","type":"parent-child","created_at":"2025-12-19T08:27:59.579846-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-dig","title":"Profile evaluation with NIX_SHOW_STATS","description":"Establish an evaluation-performance baseline before any import refactoring work begins.\n\n## Commands to run\n\\`\\`\\`bash\n# Primary benchmark - forge is the heaviest host\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel 2\u003e\u00261 | tee eval-baseline.txt\n\n# Quick check (no build, just eval)\ntime nix eval .#nixosConfigurations.forge.config.system.build.toplevel --raw 2\u003e/dev/null\n\\`\\`\\`\n\n## Key files\n- \\`modules/nixos/default.nix\\` - current monolithic import (104 service modules)\n- \\`lib/mkSystem.nix\\` - where modules get wired into hosts\n- \\`hosts/forge/default.nix\\` - heaviest host config\n\n## What to record\n- Total evaluation time\n- Number of derivations\n- Memory usage if available\n- Copy these stats into the issue notes field\n\n## Success criteria\nBaseline recorded. This issue is complete once we have numbers to compare against.","acceptance_criteria":"- Baseline eval stats recorded in the issue notes\\n- After refactors, rerun the same command(s) and record deltas\\n- Any major regressions are called out","notes":"## Baseline Results (2025-12-16)\n\n### Quick Eval Timing\n- **Wall time**: 41.43 seconds\n- **CPU time**: 17.30 seconds (user) + 2.16 seconds (sys)\n\n### NIX_SHOW_STATS Output\n| Metric | Value |\n|--------|-------|\n| CPU Time | 17.85s |\n| GC Time | 5.75s (32% of total) |\n| Heap Size | 1.85 GB |\n| Total GC Bytes | 2.80 GB |\n| Function Calls | 21.6M |\n| Thunks | 31.2M |\n| Values | 41.3M |\n| Sets | 6.1M (77.5M elements) |\n| Envs | 24.8M |\n| Expressions | 2.9M |\n\n### Module Counts\n- Service modules: 104\n- Total NixOS modules: 137\n- Forge service files: 60\n\n### Key Observations\n1. **GC pressure is high** - 32% of eval time in garbage collection\n2. **Set operations dominate** - 77M set elements, 54M values copied in updates\n3. **Many thunks** - 31M thunks suggests heavy lazy evaluation\n4. **Large heap** - 1.85GB heap for a single host config\n\n### Comparison Targets\nAfter refactoring (ehw, 58b, 1pr), re-run these commands:\n\\`\\`\\`bash\ntime nix eval .#nixosConfigurations.forge.config.system.build.toplevel --raw\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel --dry-run\n\\`\\`\\`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T14:27:05.645911-05:00","updated_at":"2025-12-16T15:24:45.825208-05:00","closed_at":"2025-12-16T15:24:45.825208-05:00"}
{"id":"nix-config-ec7","title":"Add parallel evaluation and build settings to nix.nix","description":"**Problem**: Current nix daemon settings don't optimize for parallel evaluation or builds.\n\n**COMPLETED** ✅\n\n**Changes Made**:\n- Added \\`keep-going = true\\` to \\`modules/common/nix.nix\\`\n\n**Already Present** (no changes needed):\n- \\`max-jobs = \"auto\"\\` ✅\n- \\`cores = 0\\` ✅\n- \\`http2 = true\\` ✅\n- \\`log-lines = 25\\` ✅\n\n**GC Settings Analysis**:\nThe GC settings are intentionally split for platform compatibility:\n- \\`modules/common/nix.nix\\`: \\`automatic = true\\`, \\`options = \"--delete-older-than 30d\"\\` (cross-platform)\n- \\`modules/nixos/nix.nix\\`: \\`dates = \"weekly\"\\` (NixOS-specific; Darwin uses \\`interval\\`)\n\nThis split is **correct** - consolidating would break Darwin compatibility.\n\n**Files Modified**:\n- \\`modules/common/nix.nix\\` - Added \\`keep-going = true\\`\n\n**Verification**: \n- \\`nix eval .#nixosConfigurations.forge.config.nix.settings\\` ✅\n- \\`nix eval .#nixosConfigurations.forge.config.nix.gc\\` ✅","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-16T19:50:34.682599-05:00","updated_at":"2025-12-16T20:16:08.078304-05:00","closed_at":"2025-12-16T20:15:15.381614-05:00"}
{"id":"nix-config-ehw","title":"Split service modules into category-based imports","description":"Split service modules into category-based imports so hosts can import only what they need.\n\n## Current structure\n\\`modules/nixos/default.nix\\` imports ALL 104 service modules unconditionally:\n\\`\\`\\`nix\nimports = [\n  ./services/sonarr\n  ./services/radarr\n  ./services/plex\n  # ../.. 101 more services\n];\n\\`\\`\\`\n\n## Proposed structure\nCreate category files in \\`modules/nixos/services/\\`:\n\\`\\`\\`\nmodules/nixos/services/\n├── _categories/\n│   ├── media.nix      # sonarr, radarr, plex, jellyfin, etc.\n│   ├── downloads.nix  # sabnzbd, qbittorrent, prowlarr\n│   ├── infra.nix      # caddy, postgresql, redis\n│   ├── observability.nix  # grafana, loki, prometheus\n│   ├── auth.nix       # pocketid, keycloak\n│   ├── storage.nix    # zfs, sanoid, nfs\n│   └── home.nix       # home-assistant, esphome, zigbee2mqtt\n├── default.nix        # imports all categories (backward compat)\n└── [individual services...]\n\\`\\`\\`\n\n## Implementation steps\n1. Identify which services belong to which category (review \\`hosts/forge/services/\\`)\n2. Create category import files\n3. Update \\`modules/nixos/default.nix\\` to import categories\n4. Test that \\`nix build .#nixosConfigurations.forge...\\` still works\n\n## Key files to modify\n- \\`modules/nixos/default.nix\\` - main entry point\n- \\`modules/nixos/services/default.nix\\` - service imports\n- Create new \\`modules/nixos/services/_categories/*.nix\\` files\n\n## Documentation updates (do alongside implementation)\n- [ ] Update \\`docs/repository-architecture.md\\` directory structure diagram\n- [ ] Update \\`.github/copilot-instructions.md\\` Repository Architecture section\n- [ ] Update \\`.github/prompts/nixos/service-module.prompt.md\\` Pattern Discovery Phase\n- [ ] Update \\`.github/agents/nixos-service-scaffold.agent.md\\` with category guidance\n- [ ] Update \\`.github/instructions/nixos-instructions.md\\` Module Development Workflow\n\n## Verification\n\\`\\`\\`bash\nNIX_SHOW_STATS=1 nix build .#nixosConfigurations.forge.config.system.build.toplevel\n# Compare to baseline from nix-config-dig\n\\`\\`\\`","acceptance_criteria":"- Category import files exist and are used by at least one host\\n- No service behavior changes (pure refactor)\\n- Evaluation stats do not regress","notes":"Categories implemented. 13 category files created under modules/nixos/services/_categories/. Removed privatebin (empty dir). All configs pass nix flake check. Timing: 31.5s (baseline 41.4s - no regression).","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-16T14:26:46.466962-05:00","updated_at":"2025-12-16T15:33:38.171592-05:00","closed_at":"2025-12-16T15:33:38.171592-05:00","dependencies":[{"issue_id":"nix-config-ehw","depends_on_id":"nix-config-dig","type":"blocks","created_at":"2025-12-16T14:40:55.097348-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-f02","title":"Centralize storageHelpers imports via mylib injection","description":"**Problem**: ~20+ service modules each individually import \\`../../storage/helpers-lib.nix\\`, causing redundant file parsing during evaluation.\n\n**COMPLETED** ✅\n\n**Changes Made**:\n- Modified \\`lib/default.nix\\` to add \\`storageHelpers\\` to mylib\n- Modified \\`lib/mkSystem.nix\\` to pass pkgs to storageHelpers\n- Updated **50+ service modules** to use \\`mylib.storageHelpers\\` instead of direct imports\n\n**Files Modified**:\n- \\`lib/default.nix\\`\n- \\`lib/mkSystem.nix\\`\n- \\`modules/nixos/services/attic.nix\\`\n- \\`modules/nixos/services/autobrr/default.nix\\`\n- \\`modules/nixos/services/bazarr/default.nix\\`\n- \\`modules/nixos/services/bichon/default.nix\\`\n- \\`modules/nixos/services/cooklang-federation/default.nix\\`\n- \\`modules/nixos/services/cooklang/default.nix\\`\n- \\`modules/nixos/services/cross-seed/default.nix\\`\n- \\`modules/nixos/services/dispatcharr/default.nix\\`\n- ../.. and 40+ more service modules\n\n**Verification**: \\`nix eval .#nixosConfigurations.forge.config.system.build.toplevel.name\\` passes\n\n**Impact**: Reduced redundant file parsing from ~50 imports to 1 centralized import","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-16T19:50:24.934902-05:00","updated_at":"2025-12-16T20:15:59.356434-05:00","closed_at":"2025-12-16T20:15:15.343013-05:00"}
{"id":"nix-config-gzk","title":"Consider host-specific module imports","description":"Each host should explicitly declare which module categories it needs, rather than importing everything.\n\n## Current state\nHosts implicitly get all modules via \\`lib/mkSystem.nix\\`:\n\\`\\`\\`nix\n# hosts/forge/default.nix\n{ ../.. }: {\n  imports = [ ./services ./core ./infrastructure ];\n  # Gets ALL service modules even if only using 20\n}\n\\`\\`\\`\n\n## Proposed state\n\\`\\`\\`nix\n# hosts/forge/default.nix\n{ ../.. }: {\n  imports = [ ./services ./core ./infrastructure ];\n  \n  # Explicit category selection\n  modules.categories = [ \"media\" \"downloads\" \"infra\" \"observability\" \"home\" ];\n}\n\\`\\`\\`\n\nOr directly in mkSystem call:\n\\`\\`\\`nix\n# In flake.nix or lib/mkSystem.nix\nmkSystem {\n  host = \"forge\";\n  categories = [ \"media\" \"downloads\" \"infra\" \"observability\" \"home\" ];\n}\n\\`\\`\\`\n\n## Key files\n- \\`hosts/forge/default.nix\\` - pilot host\n- \\`hosts/luna/default.nix\\` - secondary test (simpler host)\n- \\`lib/mkSystem.nix\\` - needs to support category selection\n\n## Dependencies\n- Requires nix-config-ehw (categories defined)\n- Informed by nix-config-dig (baseline comparison)\n\n## Verification\n1. Pick a simple host (luna or nixpi)\n2. Define explicit category list\n3. Verify build succeeds\n4. Verify no orphaned contributions (alerts, datasets) when service disabled","acceptance_criteria":"- At least one host switches to host-specific imports\\n- Host still builds and deploys\\n- No orphaned infrastructure contributions when a service is disabled","notes":"Implemented selective category loading in mkSystem.nix. nixpi now loads only infrastructure+observability (2 categories). Results: 18.35s vs 37.84s for forge (51% reduction). Also fixed anti-pattern where grafana-oncall and pinchflat were auto-contributing to homepage/gatus.","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-16T14:27:39.032908-05:00","updated_at":"2025-12-16T16:38:09.92787-05:00","closed_at":"2025-12-16T16:38:09.927887-05:00","dependencies":[{"issue_id":"nix-config-gzk","depends_on_id":"nix-config-ehw","type":"blocks","created_at":"2025-12-16T14:28:02.466899-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"nix-config-gzk","depends_on_id":"nix-config-dig","type":"blocks","created_at":"2025-12-16T14:40:55.131661-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-hc6","title":"Contributory Module Pattern Audit","description":"Audit all NixOS modules to ensure they follow contributory patterns correctly: no unnecessary cross-module dependencies, proper self-registration via host configs, and consistent use of shared types. Based on December 2025 architecture review against industry best practices.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-19T08:25:49.915255-05:00","updated_at":"2025-12-19T08:47:35.554434-05:00","closed_at":"2025-12-19T08:47:35.554434-05:00"}
{"id":"nix-config-mla","title":"Add flake input version pinning documentation","description":"Document the flake input version pinning policy and update workflow.\n\n## What to document\n1. **Input sources** - which inputs use stable vs unstable nixpkgs\n2. **Update cadence** - how often inputs are updated\n3. **Renovate integration** - how Renovate PRs fit in\n4. **Rollback procedure** - how to revert a bad update\n\n## Key files to reference\n- \\`flake.nix\\` - input definitions\n- \\`flake.lock\\` - pinned versions\n- \\`.github/workflows/update-flake-lock.yml\\` - automation\n- \\`Taskfile.yaml\\` - manual commands\n\n## Taskfile commands to document\n\\`\\`\\`bash\ntask --list | grep -i flake  # Find relevant tasks\n# Likely includes:\n# task nix:update-flake\n# task nix:update-input INPUT=nixpkgs\n\\`\\`\\`\n\n## Suggested doc location\n\\`docs/flake-management.md\\` or add section to \\`README.md\\`\n\n## Content outline\n\\`\\`\\`markdown\n# Flake Input Management\n\n## Inputs Overview\n| Input | Channel | Purpose |\n|-------|---------|---------|\n| nixpkgs | nixos-25.11 | Stable packages |\n| nixpkgs-unstable | nixos-unstable | Bleeding edge |\n| home-manager | release-25.11 | User environment |\n| ../.. | ../.. | ../.. |\n\n## Update Workflow\n1. Renovate creates PRs for container updates\n2. \\`task nix:update-flake\\` updates all inputs\n3. CI builds and tests\n\n## Manual Update\n\\`\\`\\`bash\ntask nix:update-flake\n# or specific input\nnix flake lock --update-input nixpkgs\n\\`\\`\\`\n\n## Rollback\n\\`\\`\\`bash\ngit checkout HEAD~1 -- flake.lock\nnix flake lock --no-update-lock-file\n\\`\\`\\`\n\\`\\`\\`\n\n## Note\nThis issue can be done independently of the architectural refactors (ehw, 58b, 8to, 1pr). However, if the lazy loading work changes how inputs are consumed, this doc may need updates.","acceptance_criteria":"- Docs describe update workflow and pinning rationale\\n- References Taskfile commands used in this repo","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-16T14:27:31.824177-05:00","updated_at":"2025-12-16T19:38:33.682437-05:00","closed_at":"2025-12-16T19:38:33.682437-05:00"}
{"id":"nix-config-r6c","title":"Document cross-module dependency patterns in ADR","description":"Based on the contributory pattern audit, document the VALID patterns for cross-module dependencies in an ADR:\n\n**Valid Patterns (keep)**:\n1. **Required dependencies with assertions** (dispatcharr → postgresql)\n   - Service genuinely cannot function without dependency\n   - Use \\`or false\\` for safe evaluation\n   - Provide clear error message\n\n2. **Optional integration validation** (teslamate → grafana)\n   - Wrap in opt-in enable flag\n   - Assert both services enabled when integration requested\n   - Use \\`or false\\` for safe evaluation\n\n3. **Orchestrator wiring** (observability → loki/promtail/grafana)\n   - Thin orchestrator explicitly wires related services\n   - Component toggles, not option re-exposure\n   - Cross-cutting concerns only\n\n4. **Safe conditional coordination** (qbit-manage → tqm)\n   - Services share resources requiring mutual exclusion\n   - All checks use \\`or false\\`\n   - Graceful degradation when dependency absent\n\n**Invalid Patterns (avoid)**:\n1. Direct contribution to another module (e.g., gatus.contributions from a service module)\n2. Unconditional config.modules.services.X.enable references\n3. Assuming another module's options exist without safe checks\n\n**Location**: docs/adr/0XX-cross-module-dependency-patterns.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T08:27:14.326271-05:00","updated_at":"2025-12-19T08:47:15.497861-05:00","closed_at":"2025-12-19T08:47:15.497861-05:00","dependencies":[{"issue_id":"nix-config-r6c","depends_on_id":"nix-config-hc6","type":"parent-child","created_at":"2025-12-19T08:27:59.406993-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"nix-config-r6c","depends_on_id":"nix-config-5dh","type":"blocks","created_at":"2025-12-19T08:28:05.019974-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"nix-config-r6c","depends_on_id":"nix-config-6qk","type":"blocks","created_at":"2025-12-19T08:28:05.068054-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"nix-config-r6c","depends_on_id":"nix-config-67j","type":"blocks","created_at":"2025-12-19T08:28:05.112735-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"nix-config-r6c","depends_on_id":"nix-config-4wb","type":"blocks","created_at":"2025-12-19T08:28:05.160099-05:00","created_by":"daemon","metadata":"{}"},{"issue_id":"nix-config-r6c","depends_on_id":"nix-config-d8o","type":"blocks","created_at":"2025-12-19T08:28:05.210292-05:00","created_by":"daemon","metadata":"{}"}]}
{"id":"nix-config-rfq","title":"Remove redundant nix.gc configuration","description":"**Problem**: nix.gc is configured in two places with conflicting/redundant settings.\n\n**CLOSED - Won't Fix** ✅\n\n**Analysis**:\nThe GC settings are intentionally split for platform compatibility:\n- \\`modules/common/nix.nix\\`: \\`automatic = true\\`, \\`options = \"--delete-older-than 30d\"\\` (cross-platform)\n- \\`modules/nixos/nix.nix\\`: \\`dates = \"weekly\"\\` (NixOS-specific; Darwin uses \\`interval\\` instead)\n\n**Why Not Consolidated**:\nConsolidating would break Darwin compatibility. The \\`dates\\` option is NixOS-specific and doesn't exist on Darwin. This split is the correct pattern for cross-platform nix configurations.\n\n**Verified by**: nix-config-ec7 agent during parallel build settings implementation.","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-12-16T19:51:03.665584-05:00","updated_at":"2025-12-16T20:17:48.349652-05:00","closed_at":"2025-12-16T20:17:48.349658-05:00"}
{"id":"nix-config-rkq","title":"Avoid builtins.readFile at module level where possible","description":"**Problem**: Using \\`builtins.readFile\\` at module evaluation time forces file reads during every nix evaluation.\n\n**Current Usages Found**:\n\\`\\`\\`\nhosts/nixpi/default.nix:75 - SSH keys\nhosts/forge/core/users.nix:16 - SSH keys  \nhosts/nixos-bootstrap/default.nix:60 - SSH keys\nhosts/luna/config/blocky.nix:69 - blocky config\nhosts/rydev/default.nix:35 - SSH keys\nhosts/luna/default.nix:45 - SSH keys\nhosts/rymac/default.nix:18 - SSH keys\nmodules/nixos/services/postgresql/default.nix:146 - SQL snippets\n\\`\\`\\`\n\n**Impact Analysis**:\n- SSH key reads: Minimal impact (small files, needed at eval time)\n- SQL snippets: Could be moved to build time if large\n- blocky config: Depends on size/complexity\n\n**Proposed Actions**:\n\n1. **SSH keys**: Keep as-is (necessary for user config)\n\n2. **SQL snippets**: Consider using \\`pkgs.writeText\\` to defer to build time:\n\\`\\`\\`nix\n# Instead of\nbuiltins.readFile ./sql/seed.sql\n# Use\n\\\\{pkgs.writeText \"seed.sql\" (builtins.readFile ./sql/seed.sql)}\n\\`\\`\\`\nNote: Only helps if the readFile result isn't needed during eval.\n\n3. **Audit for large files**: Check if any readFile targets are large.\n\n**Verification**:\n\\`\\`\\`bash\n# Check sizes of files being read\nwc -c home/ryan/config/ssh/ssh.pub\nls -la hosts/luna/config/services/\n\\`\\`\\`\n\n**Note**: This is a micro-optimization - prioritize only if files are large or eval time is critical.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-16T19:51:52.597606-05:00","updated_at":"2025-12-16T20:35:44.86345-05:00","closed_at":"2025-12-16T20:35:44.86345-05:00"}
{"id":"nix-config-t04","title":"Epic: Service Factory Pattern Implementation","description":"Implement a Helm-like factory pattern for NixOS service modules to reduce ~80% code duplication across 60+ container services.\n\n## Background\nBoth Perplexity and Gemini 3 Pro reviewed the approach and identified:\n- **CRITICAL**: spec parameter has no type validation (errors surface at runtime)\n- **HIGH**: Conditional options via lib.optionalAttrs is bad practice\n- **MEDIUM**: Debugging opacity (manageable with lib.mkDefault)\n\n## Files Created\n- lib/service-factory.nix (534 lines) - Factory functions\n- docs/shared-config-library.md - Documentation\n- modules/nixos/services/_examples/sonarr-factory-example.nix - Reference\n\n## Deliverables\n1. Spec validation using lib.evalModules\n2. Fix conditional options (always declare all options)\n3. Pilot migration (tududi service)\n4. Batch migration of media stack","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-22T11:02:12.934271-05:00","created_by":"ryan","updated_at":"2026-01-22T11:02:23.301833-05:00"}
{"id":"nix-config-t04.1","title":"Create serviceSpecSubmodule type definition","description":"Define a lib.types.submodule for the spec parameter that validates:\n- name (required, string)\n- category (required, enum: media/productivity/infrastructure/home-automation/downloads/monitoring/ai)\n- image (required for containers, string)\n- port (required, port number)\n- webUI (optional, bool, default true)\n- zfsRecordSize (optional, string, default '128K')\n- healthcheck (optional, submodule)\n- extraPodmanArgs (optional, list of strings)\n- extraEnvironment (optional, attrs)\n\n**File**: lib/types/service-spec.nix (new file)\n**Pattern**: Follow existing lib/types/*.nix structure\n**Test**: nix eval should catch typos like 'zfsRecordsize' vs 'zfsRecordSize'","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-22T11:02:34.935549-05:00","created_by":"ryan","updated_at":"2026-01-22T13:50:05.601798-05:00","closed_at":"2026-01-22T13:50:05.601798-05:00","close_reason":"Created lib/types/service-spec.nix with serviceSpecSubmodule and validateServiceSpec. Tests verify typo detection ('zfsRecordsize' error) and enum validation ('tv-shows' not valid category).","dependencies":[{"issue_id":"nix-config-t04.1","depends_on_id":"nix-config-t04","type":"parent-child","created_at":"2026-01-22T11:02:34.937067-05:00","created_by":"ryan"}]}
{"id":"nix-config-t04.2","title":"Integrate spec validation into mkContainerService","description":"Modify lib/service-factory.nix to validate the spec parameter at evaluation time using lib.evalModules.\n\n**Changes Required**:\n1. Import the new serviceSpecSubmodule type\n2. At the start of mkContainerService, validate spec:\n   ```nix\n   let\n     validatedSpec = (lib.evalModules {\n       modules = [{ options = serviceSpecSubmodule; config = spec; }];\n     }).config;\n   in\n   ```\n3. Use validatedSpec instead of raw spec throughout the function\n4. Ensure typos like `spec.zfsRecordsize` (lowercase s) fail at nix eval time\n\n**File**: lib/service-factory.nix\n**Test**: nix eval with intentional typo should produce clear error message\n**Estimated Time**: 2 hours","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-22T11:02:42.570115-05:00","created_by":"ryan","updated_at":"2026-01-22T13:53:39.365705-05:00","closed_at":"2026-01-22T13:53:39.365705-05:00","close_reason":"Integrated validateServiceSpec into mkContainerService. Added validatedSpec = sharedTypes.validateServiceSpec spec at top of function. Updated all spec references to validatedSpec. Added missing fields to spec type: containerPort, backendScheme, environmentFiles, containerOverrides, zfsCompression, zfsProperties. Flake check passes.","dependencies":[{"issue_id":"nix-config-t04.2","depends_on_id":"nix-config-t04","type":"parent-child","created_at":"2026-01-22T11:02:42.584469-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.2","depends_on_id":"nix-config-t04.1","type":"blocks","created_at":"2026-01-22T11:03:46.788763-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.2","depends_on_id":"nix-config-t04.6","type":"blocks","created_at":"2026-01-22T11:03:47.091816-05:00","created_by":"ryan"}]}
{"id":"nix-config-t04.3","title":"Remove conditional options from factory (always declare all)","description":"Fix the anti-pattern identified by Gemini 3 Pro: conditional options via lib.optionalAttrs.\n\n**Current Problem** (lib/service-factory.nix ~line 120-140):\n```nix\n// lib.optionalAttrs category.hasNfsMount {\n  mediaDir = lib.mkOption { ... };\n  nfsMountDependency = lib.mkOption { ... };\n}\n```\n\n**Issue**: Options appearing/disappearing based on category breaks introspection and type safety.\n\n**Solution**: Always declare ALL options, make behavior conditional in config section:\n```nix\noptions = {\n  # Always declare these options\n  mediaDir = lib.mkOption { type = types.nullOr types.path; default = null; };\n  nfsMountDependency = lib.mkOption { type = types.nullOr types.str; default = null; };\n  podmanNetwork = lib.mkOption { type = types.nullOr types.str; default = null; };\n  mediaGroup = lib.mkOption { type = types.nullOr types.str; default = null; };\n};\n\nconfig = lib.mkIf cfg.enable {\n  # Only USE the values when category supports them\n  systemd.services = lib.mkIf (cfg.nfsMountDependency != null) { ... };\n};\n```\n\n**File**: lib/service-factory.nix\n**Test**: All services should have consistent option schema\n**Estimated Time**: 1 hour","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-22T11:02:53.193378-05:00","created_by":"ryan","updated_at":"2026-01-22T13:56:02.279017-05:00","closed_at":"2026-01-22T13:56:02.279017-05:00","close_reason":"Removed lib.optionalAttrs from mkStandardOptions. Media-related options (mediaDir, nfsMountDependency, mediaGroup, podmanNetwork) are now always declared with category-aware defaults. This ensures consistent option interface regardless of service category. Flake check passes.","dependencies":[{"issue_id":"nix-config-t04.3","depends_on_id":"nix-config-t04","type":"parent-child","created_at":"2026-01-22T11:02:53.21095-05:00","created_by":"ryan"}]}
{"id":"nix-config-t04.4","title":"Ensure all factory outputs use lib.mkDefault","description":"Make all factory-generated configuration overridable by using lib.mkDefault throughout.\n\n**Rationale**: Without lib.mkDefault, consumers cannot override factory values without merge conflicts or mkForce.\n\n**Changes Required**:\n1. Wrap ALL generated option defaults in lib.mkDefault\n2. Wrap ALL generated config values in lib.mkDefault\n3. Document in the module how to override factory defaults\n\n**Example**:\n```nix\n# Before (hard to override)\nuser = spec.name;\n\n# After (easily overridable)\nuser = lib.mkDefault spec.name;\n```\n\n**File**: lib/service-factory.nix\n**Test**: Consumer should be able to override any factory value without mkForce\n**Estimated Time**: 30 minutes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-22T11:03:00.368852-05:00","created_by":"ryan","updated_at":"2026-01-22T13:57:36.257648-05:00","closed_at":"2026-01-22T13:57:36.257648-05:00","close_reason":"Added lib.mkDefault to ZFS dataset config (mountpoint, recordsize, compression, properties, owner, group, mode) and user config (uid, group, isSystemUser, description, extraGroups). This allows hosts to override factory defaults. Flake check passes.","dependencies":[{"issue_id":"nix-config-t04.4","depends_on_id":"nix-config-t04","type":"parent-child","created_at":"2026-01-22T11:03:00.378162-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.4","depends_on_id":"nix-config-t04.2","type":"blocks","created_at":"2026-01-22T11:03:51.925405-05:00","created_by":"ryan"}]}
{"id":"nix-config-t04.5","title":"Add _debug attribute for factory introspection","description":"Add a debug attribute to the generated module for troubleshooting and introspection.\n\n**Rationale**: Factory-generated modules are opaque; debugging is difficult without visibility into intermediate values.\n\n**Implementation**:\n```nix\nconfig = lib.mkIf cfg.enable {\n  # ... normal config ...\n  \n  # Debug attribute (accessible via config.modules.services.\u003cname\u003e._debug)\n  _debug = {\n    factoryVersion = \"1.0.0\";\n    specUsed = spec;\n    categoryApplied = category;\n    generatedOptions = builtins.attrNames options;\n    effectiveContainerConfig = containerConfig;\n  };\n};\n```\n\n**File**: lib/service-factory.nix\n**Test**: `nix eval '.#nixosConfigurations.forge.config.modules.services.sonarr._debug'`\n**Estimated Time**: 20 minutes","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-22T11:03:08.579062-05:00","created_by":"ryan","updated_at":"2026-01-22T13:58:55.822801-05:00","closed_at":"2026-01-22T13:58:55.822801-05:00","close_reason":"Added _debug attribute to factory output with: factoryVersion, serviceName, category info (name, hasNfsMount, defaultMediaGroup, tags), validatedSpec subset (port, image, zfs settings, endpoints), and derived values (serviceIds, datasetPath, mainServiceUnit, usesExternalAuth, config presence). Marked as internal=true.","dependencies":[{"issue_id":"nix-config-t04.5","depends_on_id":"nix-config-t04","type":"parent-child","created_at":"2026-01-22T11:03:08.589433-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.5","depends_on_id":"nix-config-t04.2","type":"blocks","created_at":"2026-01-22T11:03:52.086627-05:00","created_by":"ryan"}]}
{"id":"nix-config-t04.6","title":"Update lib/types.nix to export serviceSpecSubmodule","description":"Export the new serviceSpecSubmodule type through lib/types.nix for consistency with other shared types.\n\n**Changes Required**:\n1. Add import for service-spec.nix in lib/types/default.nix\n2. Export serviceSpecSubmodule in lib/types.nix (compatibility wrapper)\n3. Verify export is accessible via mylib.types.serviceSpecSubmodule\n\n**File**: lib/types/default.nix, lib/types.nix\n**Test**: `nix eval --expr 'let lib = (import \u003cnixpkgs\u003e {}).lib; mylib = import ./lib { inherit lib; }; in builtins.hasAttr \"serviceSpecSubmodule\" mylib.types' --impure`\n**Estimated Time**: 15 minutes","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-22T11:03:15.946652-05:00","created_by":"ryan","updated_at":"2026-01-22T13:50:09.646362-05:00","closed_at":"2026-01-22T13:50:09.646362-05:00","close_reason":"Type exported in lib/types/default.nix (done as part of t04.1)","dependencies":[{"issue_id":"nix-config-t04.6","depends_on_id":"nix-config-t04","type":"parent-child","created_at":"2026-01-22T11:03:15.960896-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.6","depends_on_id":"nix-config-t04.1","type":"blocks","created_at":"2026-01-22T11:03:46.937981-05:00","created_by":"ryan"}]}
{"id":"nix-config-t04.7","title":"Pilot migration: Convert tududi service to factory pattern","description":"Migrate the tududi service as the first real-world test of the refined factory.\n\n**Why tududi?**\n- Simple productivity category service\n- Single container, straightforward configuration\n- Low risk if migration has issues\n\n**Steps**:\n1. Create modules/nixos/services/tududi/default.nix using factory\n2. Keep modules/nixos/services/tududi/default.nix.bak as backup\n3. Update host config (hosts/forge/services/tududi.nix)\n4. Test with `nix build .#nixosConfigurations.forge.config.system.build.toplevel`\n5. Deploy and verify functionality\n\n**Expected Reduction**: ~300 lines → ~60 lines (80% reduction)\n\n**Deliverables**:\n- Working tududi service using factory\n- Documented any issues encountered\n- Confirmed all features preserved (backup, reverse proxy, ZFS dataset)\n\n**Estimated Time**: 2 hours","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-22T11:03:24.405023-05:00","created_by":"ryan","updated_at":"2026-01-22T15:00:17.223562-05:00","closed_at":"2026-01-22T15:00:17.223562-05:00","close_reason":"Pilot migration complete: 111 lines vs 432 original (75% reduction). Factory module now handles: notifications, preseed, ZFS datasets, Caddy registration, healthchecks. Added skipDefaultConfigMount spec option for services with custom volume mounts.","dependencies":[{"issue_id":"nix-config-t04.7","depends_on_id":"nix-config-t04","type":"parent-child","created_at":"2026-01-22T11:03:24.418135-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.7","depends_on_id":"nix-config-t04.2","type":"blocks","created_at":"2026-01-22T11:03:57.413336-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.7","depends_on_id":"nix-config-t04.3","type":"blocks","created_at":"2026-01-22T11:03:57.567145-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.7","depends_on_id":"nix-config-t04.4","type":"blocks","created_at":"2026-01-22T11:03:57.726016-05:00","created_by":"ryan"}]}
{"id":"nix-config-t04.8","title":"Batch migration: Convert media stack services (sonarr, radarr, lidarr, prowlarr)","description":"Migrate the media stack services that share nearly identical patterns.\n\n**Services to Migrate** (in order):\n1. sonarr - TV shows (most similar to example)\n2. radarr - Movies  \n3. lidarr - Music\n4. prowlarr - Indexer management\n\n**Why these services?**\n- All use 'media' category with identical options\n- Share NFS mount dependency, media group, Podman network\n- High duplication factor (\u003e90% identical code)\n\n**Steps per service**:\n1. Create new factory-based module\n2. Backup original as .bak\n3. Update host config imports\n4. Verify build succeeds\n5. Deploy to test environment\n\n**Expected Total Reduction**: ~1,600 lines → ~320 lines\n\n**Estimated Time**: 4 hours (1 hour per service)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-22T11:03:32.244187-05:00","created_by":"ryan","updated_at":"2026-01-22T21:49:42.034343-05:00","closed_at":"2026-01-22T21:49:42.034343-05:00","close_reason":"Completed: migrated sonarr, radarr, lidarr, prowlarr, bazarr, readarr (82% code reduction, commit c896944)","dependencies":[{"issue_id":"nix-config-t04.8","depends_on_id":"nix-config-t04","type":"parent-child","created_at":"2026-01-22T11:03:32.257867-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.8","depends_on_id":"nix-config-t04.7","type":"blocks","created_at":"2026-01-22T11:04:02.373484-05:00","created_by":"ryan"}]}
{"id":"nix-config-t04.9","title":"Update documentation with final patterns and lessons learned","description":"Update docs/shared-config-library.md with:\n\n1. **Final API reference** after validation changes\n2. **Migration lessons learned** from pilot and batch migrations\n3. **Troubleshooting guide** for common issues\n4. **Decision record** documenting why spec validation was added\n\n**Sections to add/update**:\n- Spec submodule type reference\n- Error messages and what they mean\n- How to override factory defaults\n- How to use _debug attribute\n- Common migration pitfalls\n\n**File**: docs/shared-config-library.md\n**Estimated Time**: 1 hour","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-22T11:03:39.219317-05:00","created_by":"ryan","updated_at":"2026-01-22T22:47:09.863201-05:00","closed_at":"2026-01-22T22:47:09.863201-05:00","close_reason":"Documentation updated with runAsRoot option, troubleshooting guide, and migration lessons learned","dependencies":[{"issue_id":"nix-config-t04.9","depends_on_id":"nix-config-t04","type":"parent-child","created_at":"2026-01-22T11:03:39.226684-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.9","depends_on_id":"nix-config-t04.7","type":"blocks","created_at":"2026-01-22T11:04:02.545316-05:00","created_by":"ryan"},{"issue_id":"nix-config-t04.9","depends_on_id":"nix-config-t04.8","type":"blocks","created_at":"2026-01-22T11:04:02.697921-05:00","created_by":"ryan"}]}

---
version: "3"

tasks:
  extract-ssh-key:
    desc: Extract SSH host key from target and convert to age format
    silent: true
    summary: |
      Extracts the SSH ed25519 host public key from a target host and converts it to age format.
      This age key can then be added to .sops.yaml for secrets encryption.

      Args:
        host: Target hostname (required)
        ssh_user: SSH user (default: ryan)
        NIXOS_DOMAIN: Domain suffix (default: holthome.netinternal)
        method: Extraction method - 'ssh' or 'scan' (default: ssh)

      Examples:
        task bootstrap:extract-ssh-key host=forge
        task bootstrap:extract-ssh-key host=luna method=scan
        task bootstrap:extract-ssh-key host=newhost ssh_user=ryan NIXOS_DOMAIN=holthome.net
    vars:
      ssh_user: '{{.ssh_user | default "ryan"}}'
      NIXOS_DOMAIN: '{{.NIXOS_DOMAIN | default "holthome.net"}}'
      method: '{{.method | default "ssh"}}'
      fqdn:
        sh: 'echo "{{.host}}.{{.NIXOS_DOMAIN}}"'
    requires:
      vars:
        - host
    cmds:
      - |
        set -euo pipefail

        echo "ðŸ“¡ Extracting SSH host key from {{.fqdn}}..." >&2

        case "{{.method}}" in
          ssh)
            echo "  Method: Direct SSH read" >&2
            # Capture stderr separately to filter out SSH warnings
            if ! output=$(ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=10 -o BatchMode=yes -o LogLevel=ERROR \
              "{{.ssh_user}}@{{.fqdn}}" \
              'if [ -f /etc/ssh/ssh_host_ed25519_key.pub ]; then
                cat /etc/ssh/ssh_host_ed25519_key.pub
              elif [ -f /persist/etc/ssh/ssh_host_ed25519_key.pub ]; then
                cat /persist/etc/ssh/ssh_host_ed25519_key.pub
              else
                echo "ERROR: No SSH host key found" >&2
                exit 1
              fi' 2>&1); then
              echo "âŒ SSH connection failed to {{.ssh_user}}@{{.fqdn}}" >&2
              echo "   Error: $output" >&2
              echo "" >&2
              echo "ðŸ’¡ Troubleshooting tips:" >&2
              echo "   - Is the system fully booted? (wait 2-3 minutes after reboot)" >&2
              echo "   - Try the scan method: task bootstrap:extract-ssh-key host={{.host}} method=scan" >&2
              echo "   - For LiveCD, use: task bootstrap:extract-ssh-key host={{.host}} ssh_user=nixos" >&2
              exit 1
            fi
            # Filter out only the SSH public key line (starts with ssh-)
            pub=$(echo "$output" | grep '^ssh-' | head -n1)
            if [ -z "$pub" ]; then
              echo "âŒ Failed to extract SSH public key from output" >&2
              echo "   Output was: $output" >&2
              exit 1
            fi
            ;;
          scan)
            echo "  Method: SSH keyscan" >&2
            pub=$(ssh-keyscan -t ed25519 "{{.fqdn}}" 2>/dev/null | grep -v '^#' | awk '{print $2" "$3}' | head -n1)
            ;;
          *)
            echo "âŒ Invalid method '{{.method}}' (use 'ssh' or 'scan')" >&2
            exit 1
            ;;
        esac

        if [ -z "$pub" ]; then
          echo "âŒ No ed25519 host key found on {{.fqdn}}" >&2
          echo "   Make sure the host is booted and SSH is accessible" >&2
          exit 1
        fi

        echo "  Found SSH key: ${pub:0:50}..." >&2
        echo "" >&2
        echo "ðŸ”‘ Converting to age format..." >&2

        # Try ssh-to-age from PATH first, then fall back to nix
        if command -v ssh-to-age >/dev/null 2>&1; then
          age_key=$(echo "$pub" | ssh-to-age)
        else
          echo "  Using nix shell for ssh-to-age..." >&2
          age_key=$(echo "$pub" | nix shell nixpkgs#ssh-to-age -c ssh-to-age)
        fi

        if [ -z "$age_key" ]; then
          echo "âŒ Failed to convert SSH key to age format" >&2
          exit 1
        fi

        echo "" >&2
        echo "âœ… Age public key for {{.host}}:" >&2
        echo "" >&2
        echo "$age_key"
        echo "" >&2
        echo "ðŸ“ Next steps:" >&2
        echo "  1. Add this key to .sops.yaml under creation_rules[].age" >&2
        echo "  2. Run: task sops:re-encrypt" >&2
        echo "  3. Deploy full config: task nix:apply-nixos host={{.host}}" >&2
    preconditions:
      - sh: which ssh
        msg: "ssh not found"
      - sh: which nix
        msg: "nix not found"

  remote-install:
    desc: Remotely format disks and install NixOS bootstrap (or recover from backup)
    silent: true
    summary: |
      Performs complete remote NixOS installation including disk formatting.
      Requires LiveCD to be booted with SSH access (password set).

      Args:
        host: Target hostname (required)
        ssh_user: SSH user for LiveCD (default: nixos)
        NIXOS_DOMAIN: Domain suffix (default: holthome.net)
        RECOVER: Enable disaster recovery mode - restore system datasets from nas-1 (default: false)

      Examples:
        task bootstrap:remote-install host=forge
        task bootstrap:remote-install host=luna ssh_user=nixos
        task bootstrap:remote-install host=forge RECOVER=true  # Disaster recovery

      Prerequisites:
        - LiveCD booted on target system
        - SSH password set: sudo passwd nixos
        - Network connectivity established
        - For RECOVER=true: SSH agent running with nas-1 key loaded
    vars:
      ssh_user: '{{.ssh_user | default "nixos"}}'
      NIXOS_DOMAIN: '{{.NIXOS_DOMAIN | default "holthome.net"}}'
      RECOVER: '{{.RECOVER | default "false"}}'
      fqdn:
        sh: 'echo "{{.host}}.{{.NIXOS_DOMAIN}}"'
    requires:
      vars:
        - host
    cmds:
      - |
        set -euo pipefail

        echo "ðŸš€ Remote NixOS installation starting for {{.fqdn}}" >&2
        echo "" >&2

        # Step 1: Set hostid and format disks
        echo "ðŸ“¡ Step 1/3: Setting hostid and formatting disks..." >&2
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          "{{.ssh_user}}@{{.fqdn}}" \
          'set -euo pipefail
           echo "ðŸ”§ Reading hostid from flake config..."
           hostid=$(nix eval --extra-experimental-features "nix-command flakes" --raw github:carpenike/nix-config#nixosConfigurations.{{.host}}.config.networking.hostId)
           echo "ðŸ“ Setting hostid to $hostid"
           if [ -f /etc/hostid ]; then
             echo "âš ï¸  Hostid file exists, removing and recreating..."
             sudo rm -f /etc/hostid
           fi
           sudo zgenhostid "$hostid"
           echo "ðŸ’¾ Formatting disks with disko..."
           sudo nix run --extra-experimental-features "nix-command flakes" \
             github:nix-community/disko -- --mode disko --flake github:carpenike/nix-config#{{.host}}'

        echo "âœ… Disk formatting completed" >&2
        echo "" >&2

        # Step 1.5: Conditional disaster recovery preseed restoration
        if [ "{{.RECOVER}}" = "true" ]; then
          echo "ðŸ”„ Step 1.5/4: Restoring datasets from nas-1 (DISASTER RECOVERY MODE)..." >&2
          echo "  Using SSH agent forwarding for authentication" >&2

          # Use SSH agent forwarding (-A) to authenticate to nas-1 without exposing keys
          ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "{{.ssh_user}}@{{.fqdn}}" \
            'set -euo pipefail
             echo "ï¿½ Installing syncoid (required for dataset restoration)..."
             nix-shell -p sanoid --run "echo syncoid available"

             echo " Setting up SSH known_hosts for root..."
             # Root needs to know nas-1 host key (syncoid runs as root)
             sudo mkdir -p /root/.ssh
             sudo sh -c "ssh-keyscan -H nas-1 >> /root/.ssh/known_hosts 2>/dev/null || true"

             echo "ðŸ’¾ Restoring system datasets..."
             echo "  â†’ rpool/safe/persist (SSH keys, SOPS secrets, system state)"
             # Run syncoid as root with SSH agent forwarding (-E preserves SSH_AUTH_SOCK)
             # Source: ryan@nas-1 (uses your forwarded SSH key)
             # Destination: local dataset (no SSH needed)
             # --force-delete: Allow overwriting empty datasets created by disko
             sudo -E nix-shell -p sanoid --run "syncoid -r --no-sync-snap --force-delete \
               ryan@nas-1:backup/{{.host}}/zfs-recv/persist \
               rpool/safe/persist"

             echo "  â†’ rpool/safe/home (user data)"
             sudo -E nix-shell -p sanoid --run "syncoid -r --no-sync-snap --force-delete \
               ryan@nas-1:backup/{{.host}}/zfs-recv/home \
               rpool/safe/home"

             echo ""
             echo "â„¹ï¸  Service datasets will be restored automatically by preseed services on first boot"
             echo "âœ… System dataset restoration completed"'

          echo "âœ… Preseed restoration completed" >&2
          echo "" >&2
        fi

        # Step 2: Always install nixos-bootstrap (never full config during install)
        echo "ðŸ“¡ Step 2/4: Installing NixOS bootstrap..." >&2
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          "{{.ssh_user}}@{{.fqdn}}" \
          'set -euo pipefail
           echo "ðŸ”§ Installing minimal NixOS bootstrap configuration..."
           sudo nixos-install --flake github:carpenike/nix-config#nixos-bootstrap --root /mnt --no-root-password'

        echo "âœ… NixOS installation completed" >&2
        echo "" >&2

        # Step 3: Reboot
        echo "ðŸ“¡ Step 3/4: Rebooting to installed system..." >&2
        echo "ðŸ”„ Initiating reboot (connection will drop)..." >&2
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          "{{.ssh_user}}@{{.fqdn}}" \
          'sudo reboot' || true

        echo "" >&2
        echo "âœ… Remote installation completed!" >&2
        echo "" >&2

        if [ "{{.RECOVER}}" = "true" ]; then
          echo "ðŸŽ‰ DISASTER RECOVERY MODE - Datasets restored from backup!" >&2
          echo "" >&2
          echo "ðŸ“ Next steps:" >&2
          echo "  1. Wait for system to reboot (~2-3 minutes)" >&2
          echo "  2. âš ï¸  NO SSH key extraction needed (keys restored from backup)" >&2
          echo "  3. Deploy full config: task nix:apply-nixos host={{.host}}" >&2
          echo "  4. Verify restoration: ssh ryan@{{.fqdn}}" >&2
          echo "  5. Check services: systemctl status" >&2
          echo "" >&2
          echo "â„¹ï¸  After reboot:" >&2
          echo "    - Impermanence will activate (/persist â†’ /etc/ssh bind mounts)" >&2
          echo "    - Full config deployment will decrypt secrets with restored keys" >&2
          echo "    - Services will start with restored data" >&2
        else
          echo "ðŸ“ Next steps:" >&2
          echo "  1. Wait for system to reboot (~2-3 minutes)" >&2
          echo "  2. Extract SSH key: task bootstrap:extract-ssh-key host={{.host}}" >&2
          echo "  3. Add age key to .sops.yaml and re-encrypt: task sops:re-encrypt" >&2
          echo "  4. Deploy full config: task nix:apply-nixos host={{.host}}" >&2
        fi
        echo "" >&2
    preconditions:
      - sh: which ssh
        msg: "ssh not found"
      - sh: which nix
        msg: "nix not found"

  quickstart:
    desc: Show bootstrap quickstart guide
    silent: true
    cmds:
      - |
        echo "ðŸš€ NixOS Host Bootstrap - Quick Reference"
        echo ""
        echo "ðŸ“š Full documentation: docs/bootstrap-quickstart.md"
        echo ""
        echo "âš¡ Remote workflow for NEW HOSTS (from your Mac):"
        echo "  1. Boot LiveCD on target, set password: sudo passwd nixos"
        echo "  2. Remote install: task bootstrap:remote-install host=HOSTNAME"
        echo "  3. Extract SSH key: task bootstrap:extract-ssh-key host=HOSTNAME"
        echo "  4. Add age key to .sops.yaml and re-encrypt: task sops:re-encrypt"
        echo "  5. Deploy full config: task nix:apply-nixos host=HOSTNAME"
        echo ""
        echo "ðŸ”„ DISASTER RECOVERY workflow (restore from nas-1 backup):"
        echo "  1. Boot LiveCD on target, set password: sudo passwd nixos"
        echo "  2. Ensure SSH agent has nas-1 key: ssh-add -l"
        echo "  3. Remote install with recovery: task bootstrap:remote-install host=HOSTNAME RECOVER=true"
        echo "     (Restores: persist + home from nas-1; services auto-restore on boot)"
        echo "  4. Wait for reboot, then deploy full config: task nix:apply-nixos host=HOSTNAME"
        echo "  5. Verify restoration: ssh ryan@HOSTNAME.holthome.net"
        echo ""
        echo "  â„¹ï¸  DR uses two-phase bootstrap (same as new host):"
        echo "      Phase 1: Install nixos-bootstrap (activates impermanence on first boot)"
        echo "      Phase 2: Deploy full config (SOPS works with restored SSH keys)"
        echo ""
        echo "âš¡ NIXOS-ANYWHERE workflow (kexec - no ISO needed):"
        echo "  Use when target runs ANY Linux with SSH (cloud VPS, existing install):"
        echo "  1. Ensure SSH access: ssh root@TARGET_IP"
        echo "  2. Run: task bootstrap:nixos-anywhere host=HOSTNAME ip=TARGET_IP"
        echo "  3. Wait for reboot, extract SSH key: task bootstrap:extract-ssh-key host=HOSTNAME"
        echo "  4. Deploy full config: task nix:apply-nixos host=HOSTNAME"
        echo ""
        echo "ðŸ”€ KEXEC-ONLY workflow (boot to installer, then use remote-install):"
        echo "  Use when you want kexec convenience but need remote-install features (DR, custom install):"
        echo "  1. Ensure SSH access: ssh root@TARGET_IP (or user with sudo)"
        echo "  2. Kexec to installer: task bootstrap:kexec-to-installer ip=TARGET_IP"
        echo "     (copies your SSH key to root, then kexecs)"
        echo "  3. Wait ~2min, test SSH: ssh root@TARGET_IP"
        echo "  4. Run: task bootstrap:remote-install host=HOSTNAME ssh_user=root"
        echo "     (or with DR: task bootstrap:remote-install host=HOSTNAME ssh_user=root RECOVER=true)"
        echo ""
        echo "âš™ï¸  Manual workflow (if you prefer local install):"
        echo "  1. Boot LiveCD, set password: sudo passwd nixos"
        echo "  2. Set hostid and format:"
        echo "     hostid=\$(nix eval --raw github:carpenike/nix-config#nixosConfigurations.HOSTNAME.config.networking.hostId)"
        echo "     sudo zgenhostid \"\$hostid\""
        echo "     sudo nix run github:nix-community/disko -- --mode disko --flake github:carpenike/nix-config#HOSTNAME"
        echo "  3. Install: nixos-install --flake github:carpenike/nix-config#nixos-bootstrap --root /mnt --no-root-password"
        echo "  4. Reboot (system creates user 'ryan')"
        echo "  5. Extract SSH key: task bootstrap:extract-ssh-key host=HOSTNAME"
        echo "  6. Add age key to .sops.yaml and re-encrypt: task sops:re-encrypt"
        echo "  7. Deploy full config: task nix:apply-nixos host=HOSTNAME"
        echo ""
        echo "ðŸ†• For NEW hosts (not in repo yet):"
        echo "  â€¢ Generate hostId first: head -c 8 /dev/urandom | od -An -tx1 | tr -d ' \n'"
        echo "  â€¢ Create host directory and update flake.nix BEFORE step 2"
        echo "  â€¢ See full docs for details"
        echo ""
        echo "ðŸ‘¤ Users:"
        echo "  â€¢ LiveCD/kexec installer: root (or nixos on official ISO)"
        echo "  â€¢ After install: ryan (created by nixos-bootstrap, has sudo)"
        echo ""
        echo "ðŸ“‹ Available tasks:"
        echo "  task bootstrap:extract-ssh-key host=HOSTNAME  - Extract SSH key remotely"
        echo "  task bootstrap:remote-install host=HOSTNAME   - Install from LiveCD/kexec installer"
        echo "  task bootstrap:kexec-to-installer ip=IP       - Boot any Linux into NixOS installer"
        echo "  task bootstrap:nixos-anywhere host=H ip=IP    - Full install via kexec (no ISO)"
        echo "  task bootstrap:quickstart                     - Show this help"
        echo ""

  nixos-anywhere:
    desc: Install NixOS via nixos-anywhere (kexec, no ISO required)
    silent: true
    summary: |
      Uses nixos-anywhere to install NixOS on a target running any Linux with SSH.
      This uses kexec to boot into NixOS installer without needing physical access or ISO.

      âš ï¸  This will WIPE ALL DATA on target disks!

      Args:
        host: Target hostname from flake (required)
        ip: Target IP address (required)
        ssh_user: SSH user (default: root)
        build_on_remote: Build on target instead of locally (default: false)

      Examples:
        task bootstrap:nixos-anywhere host=forge ip=192.168.1.100
        task bootstrap:nixos-anywhere host=luna ip=10.0.0.50 ssh_user=admin
        task bootstrap:nixos-anywhere host=forge ip=192.168.1.100 build_on_remote=true

      Prerequisites:
        - Target running any x86_64 Linux with SSH and kexec support
        - Root access (or passwordless sudo)
        - Wired network (wifi not supported)

      Notes:
        - Builds locally by default (faster for slow targets)
        - Uses nixos-bootstrap config (not full host config)
        - Follow up with: task nix:apply-nixos host=HOSTNAME
    vars:
      ssh_user: '{{.ssh_user | default "root"}}'
      build_on_remote: '{{.build_on_remote | default "false"}}'
    requires:
      vars:
        - host
        - ip
    cmds:
      - |
        set -euo pipefail

        echo "ðŸš€ nixos-anywhere installation for {{.host}} at {{.ip}}" >&2
        echo "" >&2
        echo "âš ï¸  WARNING: This will WIPE ALL DATA on target disks!" >&2
        echo "   Target: {{.ssh_user}}@{{.ip}}" >&2
        echo "   Config: nixos-bootstrap (minimal, follow up with full deploy)" >&2
        echo "" >&2
        read -p "Type 'yes' to continue: " confirm
        if [ "$confirm" != "yes" ]; then
          echo "âŒ Aborted" >&2
          exit 1
        fi

        echo "" >&2
        echo "ðŸ“¦ Running nixos-anywhere..." >&2

        build_flag=""
        if [ "{{.build_on_remote}}" = "true" ]; then
          echo "  Building on remote target" >&2
          build_flag="--build-on-remote"
        else
          echo "  Building locally, copying closure to target" >&2
        fi

        nix run github:nix-community/nixos-anywhere -- \
          --flake ".#nixos-bootstrap" \
          --target-host "{{.ssh_user}}@{{.ip}}" \
          $build_flag

        echo "" >&2
        echo "âœ… nixos-anywhere completed!" >&2
        echo "" >&2
        echo "ðŸ“ Next steps:" >&2
        echo "  1. Wait for system to reboot (~2-3 minutes)" >&2
        echo "  2. Extract SSH key: task bootstrap:extract-ssh-key host={{.host}}" >&2
        echo "  3. Add age key to .sops.yaml and re-encrypt: task sops:re-encrypt" >&2
        echo "  4. Deploy full config: task nix:apply-nixos host={{.host}}" >&2
    preconditions:
      - sh: which nix
        msg: "nix not found"

  kexec-to-installer:
    desc: Boot target into NixOS installer via kexec (no installation)
    silent: true
    summary: |
      Uses kexec to boot any Linux machine into a NixOS installer environment.
      This is useful when you want to use your own installation process (e.g., remote-install)
      but don't have physical access to boot a LiveCD.

      After kexec, the machine will be in the same state as if you booted a NixOS ISO.
      You can then run: task bootstrap:remote-install host=HOSTNAME

      Args:
        ip: Target IP address (required)
        ssh_user: SSH user (default: root)

      Examples:
        task bootstrap:kexec-to-installer ip=192.168.1.100
        task bootstrap:kexec-to-installer ip=10.0.0.50 ssh_user=admin

      Prerequisites:
        - Target running any x86_64 Linux with SSH and kexec support
        - Root access (or passwordless sudo)
        - At least 1GB RAM (installer runs in RAM)

      Authentication after kexec:
        The kexec installer imports SSH keys from /root/.ssh/authorized_keys on the
        original system. If root had your SSH key, you can SSH as root after kexec.
        If not, the task will set up your key before kexec.

      After kexec completes:
        - SSH as root@IP (uses your SSH key)
        - Run: task bootstrap:remote-install host=HOSTNAME ssh_user=root
    vars:
      ssh_user: '{{.ssh_user | default "root"}}'
    requires:
      vars:
        - ip
    cmds:
      - |
        set -euo pipefail

        echo "ðŸš€ Kexec to NixOS installer at {{.ip}}" >&2
        echo "" >&2
        echo "This will:" >&2
        echo "  1. Set up SSH key for root (so you can SSH after kexec)" >&2
        echo "  2. Download NixOS kexec image" >&2
        echo "  3. Reboot target into NixOS installer (runs in RAM)" >&2
        echo "  4. Leave you with SSH access as root" >&2
        echo "" >&2
        echo "âš ï¸  The current OS will be replaced in memory (data on disk is safe until you format)" >&2
        echo "" >&2
        read -p "Type 'yes' to continue: " confirm
        if [ "$confirm" != "yes" ]; then
          echo "âŒ Aborted" >&2
          exit 1
        fi

        echo "" >&2

        # Step 1: Ensure root has our SSH key (kexec installer imports /root/.ssh/authorized_keys)
        echo "ðŸ”‘ Setting up SSH key for root (will persist into kexec installer)..." >&2
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          "{{.ssh_user}}@{{.ip}}" \
          "set -euo pipefail
           # Get our current SSH public key
           mkdir -p /root/.ssh
           chmod 700 /root/.ssh
           # Add the key that's being used for this connection
           # This ensures the same key works after kexec
           if [ ! -f /root/.ssh/authorized_keys ] || ! grep -q '$(cat ~/.ssh/id_ed25519.pub 2>/dev/null || cat ~/.ssh/id_rsa.pub 2>/dev/null || echo "")' /root/.ssh/authorized_keys 2>/dev/null; then
             echo 'Adding SSH key to root authorized_keys...'
           fi"

        # Copy our SSH key to root's authorized_keys
        echo "  Copying your SSH public key to target..." >&2
        ssh_pub_key=$(cat ~/.ssh/id_ed25519.pub 2>/dev/null || cat ~/.ssh/id_rsa.pub 2>/dev/null || echo "")
        if [ -n "$ssh_pub_key" ]; then
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "{{.ssh_user}}@{{.ip}}" \
            "mkdir -p /root/.ssh && chmod 700 /root/.ssh && echo '$ssh_pub_key' >> /root/.ssh/authorized_keys && chmod 600 /root/.ssh/authorized_keys && sort -u /root/.ssh/authorized_keys -o /root/.ssh/authorized_keys"
          echo "  âœ… SSH key configured for root" >&2
        else
          echo "  âš ï¸  No SSH public key found locally, hoping root already has one configured" >&2
        fi

        echo "" >&2
        echo "ðŸ“¦ Downloading and running kexec..." >&2

        # Download and run kexec
        kexec_url="https://github.com/nix-community/nixos-images/releases/download/nixos-unstable/nixos-kexec-installer-noninteractive-x86_64-linux.tar.gz"

        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          "{{.ssh_user}}@{{.ip}}" \
          "set -euo pipefail
           echo 'ðŸ“¥ Downloading NixOS kexec image...'
           curl -L '$kexec_url' | tar -xzf- -C /root
           echo 'ðŸ”„ Executing kexec (connection will drop)...'
           /root/kexec/run"

        echo "" >&2
        echo "âœ… Kexec initiated! Connection dropped as expected." >&2
        echo "" >&2
        echo "â³ Wait ~1-2 minutes for the installer to boot..." >&2
        echo "" >&2
        echo "ðŸ“ Next steps:" >&2
        echo "  1. Test SSH: ssh root@{{.ip}}" >&2
        echo "  2. Run installation: task bootstrap:remote-install host=HOSTNAME ssh_user=root" >&2
        echo "     Or with DR: task bootstrap:remote-install host=HOSTNAME ssh_user=root RECOVER=true" >&2
        echo "" >&2
        echo "ðŸ’¡ The installer has:" >&2
        echo "   - Your SSH key (copied before kexec)" >&2
        echo "   - Full Nix tooling available" >&2
        echo "   - Disks untouched until you run disko" >&2
    preconditions:
      - sh: which ssh
        msg: "ssh not found"

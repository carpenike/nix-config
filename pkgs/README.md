<h1 align="center">ğŸ“¦ Custom Packages</h1>

<p align="center">
  <em>Local package definitions with automated upstream tracking</em>
</p>

---

## ğŸ“‹ Table of Contents

- [Overview](#-overview)
- [Package Inventory](#-package-inventory)
- [nvfetcher Workflow](#-nvfetcher-workflow)
- [Adding New Packages](#-adding-new-packages)
- [Building Packages](#-building-packages)

---

## ğŸ” Overview

This directory contains custom Nix package definitions that aren't available in nixpkgs or need local modifications. Packages are managed through two mechanisms:

1. **Local derivations** (`default.nix`) â€” Handwritten packages for backup tooling and utilities
2. **nvfetcher** (`nvfetcher.toml`) â€” Automated source fetching for upstream GitHub releases

---

## ğŸ“¦ Package Inventory

### Backup & Operations

| Package | Description |
|---------|-------------|
| `backup-list` | List configured Restic backup repositories |
| `backup-orchestrator` | Coordinate backup jobs across services |
| `backup-status` | Display backup job status and health |
| `syncoid-list` | List ZFS replication (Syncoid) configurations |

### Kubernetes Tools

| Package | Description |
|---------|-------------|
| `kubecolor-catppuccin` | Catppuccin theme for kubecolor output |
| `kubectl-browse-pvc` | Browse PersistentVolumeClaim contents |
| `kubectl-klock` | Watch resources with live updates |
| `kubectl-netshoot` | Network troubleshooting container |
| `kubectl-node-shell` | Direct node shell access |
| `kubectl-pgo` | PostgreSQL Operator CLI |
| `kubectl-rook-ceph` | Rook Ceph management CLI |
| `kubectl-view-secret` | Decode and view secrets |

### Applications

| Package | Description |
|---------|-------------|
| `alerta-webui` | Web UI for Alerta alert management system |
| `cooklang-cli` | Cooklang recipe markup parser |
| `cooklang-federation` | Recipe federation server |
| `shcopy` | Shell-based file copy utility |
| `usage` | CLI usage tracking and analytics |

---

## ğŸ”„ nvfetcher Workflow

[nvfetcher](https://github.com/berberman/nvfetcher) automatically tracks upstream releases and updates source hashes.

### Configuration

Sources are defined in `nvfetcher.toml`:

```toml
[cooklang-cli]
src.github = "cooklang/cooklang-rs"
fetch.github = "cooklang/cooklang-rs"
```

### Updating Sources

```bash
# Update all tracked packages
cd pkgs && nvfetcher

# This regenerates _sources/generated.nix with fresh hashes
```

### Generated Files

| File | Purpose |
|------|---------|
| `nvfetcher.toml` | Source definitions (edit this) |
| `_sources/generated.nix` | Auto-generated fetch expressions |
| `_sources/generated.json` | Machine-readable version info |

> [!NOTE]
> Never edit files in `_sources/` directly â€” they're regenerated by nvfetcher.

---

## â• Adding New Packages

### Option 1: Local Package

1. Create a new directory: `pkgs/my-package/`
2. Add `default.nix` with the derivation
3. Register in `pkgs/default.nix`:

```nix
my-package = pkgs.callPackage ./my-package { };
```

### Option 2: nvfetcher-Tracked Package

1. Add entry to `nvfetcher.toml`:

```toml
[my-package]
src.github = "owner/repo"
fetch.github = "owner/repo"
```

2. Run `nvfetcher` to generate sources
3. Create derivation referencing `sources.my-package`
4. Register in `pkgs/default.nix`

---

## ğŸ”¨ Building Packages

```bash
# Build a specific package
nix build .#cooklang-cli

# Build and run immediately
nix run .#backup-status

# Enter development shell with package
nix shell .#kubectl-browse-pvc
```

---

## ğŸ“ Directory Structure

```
pkgs/
â”œâ”€â”€ default.nix          # Package registry (exports all packages)
â”œâ”€â”€ nvfetcher.toml       # Upstream source definitions
â”œâ”€â”€ _sources/            # nvfetcher generated files
â”‚   â”œâ”€â”€ generated.nix
â”‚   â””â”€â”€ generated.json
â”œâ”€â”€ backup-list/         # Local package directories
â”œâ”€â”€ cooklang-cli/
â””â”€â”€ ...
```
